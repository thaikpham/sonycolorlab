<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO: Th√™m th·∫ª meta description ƒë·ªÉ m√¥ t·∫£ n·ªôi dung trang cho c√¥ng c·ª• t√¨m ki·∫øm -->
    <meta name="description" content="Kh√°m ph√°, t·∫°o v√† so s√°nh c√°c c√¥ng th·ª©c m√†u Picture Profile cho m√°y ·∫£nh Sony Alpha v·ªõi s·ª± tr·ª£ gi√∫p c·ªßa AI. T√¨m m√†u s·∫Øc ƒë·∫∑c tr∆∞ng c·ªßa ri√™ng b·∫°n.">
    
    <title>Sony AI Color Lab Web-App</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 6.253v11.494m-5.747-8.662l11.494 5.747m-11.494 0l11.494-5.747M4.75 12A7.25 7.25 0 0112 4.75v0A7.25 7.25 0 0119.25 12v0a7.25 7.25 0 01-7.25 7.25v0A7.25 7.25 0 014.75 12v0z' stroke='%231d1d1f' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round' fill='none'%3E%3C/path%3E%3C/svg%3E">
    
    <!-- Performance: S·ª≠ d·ª•ng 'defer' ƒë·ªÉ c√°c script kh√¥ng ch·∫∑n vi·ªác render HTML -->
    <script src="https://cdn.tailwindcss.com" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f4f7fc;
            color: #212529;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        #bg-blurs { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .blur-circle { position: absolute; border-radius: 50%; filter: blur(180px); opacity: 0.15; transition: all 2s ease-in-out; }
        .blur-1 { width: 40vw; height: 40vw; max-width: 500px; max-height: 500px; background: #007AFF; top: 5%; left: 10%; animation: move-blur-1 30s infinite alternate; }
        .blur-2 { width: 50vw; height: 50vw; max-width: 600px; max-height: 600px; background: #FF9500; bottom: 5%; right: 10%; animation: move-blur-2 35s infinite alternate; }
        @keyframes move-blur-1 { from { transform: translate(0, 0) scale(1) rotate(0deg); } to { transform: translate(10vw, 5vh) scale(1.3) rotate(55deg); } }
        @keyframes move-blur-2 { from { transform: translate(0, 0) scale(1) rotate(0deg); } to { transform: translate(-8vw, -5vh) scale(1.2) rotate(-70deg); } }

        :root {
            --primary-accent: #007AFF;
            --primary-accent-darker: #0056B3;
            --glass-bg: rgba(255, 255, 255, 0.55);
            --glass-border: rgba(0, 0, 0, 0.07);
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
        }
        
        .glass-panel {    
            background: var(--glass-bg);    
            backdrop-filter: blur(40px) saturate(180%);    
            -webkit-backdrop-filter: blur(40px) saturate(180%);    
            border: 1px solid var(--glass-border);    
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.08);
            border-radius: 24px;
        }
        @media (min-width: 768px) {
            .glass-panel { border-radius: 28px; }
        }

        .recipe-item.selected {    
            background-color: rgba(0, 122, 255, 0.1);    
            border-left: 4px solid var(--primary-accent);    
            color: var(--text-primary);    
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.1);
        }
        .recipe-item:hover:not(.selected) { background-color: rgba(0, 0, 0, 0.04); }
        .recipe-dot { transition: transform 0.2s ease-in-out; }
        .recipe-dot:hover { transform: scale(1.25); }

        .btn { border-radius: 9999px; font-weight: 600; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .btn-primary { background-color: var(--primary-accent); border: none; color: white; box-shadow: 0 4px 14px rgba(0, 118, 255, 0.39); }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-accent-darker); transform: translateY(-2px) scale(1.02); box-shadow: 0 6px 18px rgba(0, 118, 255, 0.45); }
        .btn:disabled { background-color: #b0bec5; cursor: not-allowed; opacity: 0.7; box-shadow: none; }
        
        .lang-btn { background: #e9ecef; border: none; border-radius: 9999px; padding: 0.25rem; transition: all 0.2s ease; }
        .lang-btn.active { box-shadow: 0 0 0 2.5px var(--primary-accent); }
        .lang-btn svg { width: 1.5rem; height: 1.5rem; }
        
        .landing-title { font-size: clamp(2.2rem, 5.5vw, 4.5rem); font-weight: 800; color: var(--text-primary); line-height: 1.1; letter-spacing: -0.025em; }
        .quiz-question-title { font-size: clamp(1.7rem, 5vw, 3rem); font-weight: 700; color: var(--text-primary); line-height: 1.15; letter-spacing: -0.02em; }
        .landing-subtitle { font-size: clamp(1rem, 2.5vw, 1.25rem); color: var(--text-secondary); margin-top: 1.25rem; max-width: 650px; line-height: 1.6; }
        
        .view-transition { animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .view-transition-out { animation: fadeOutDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-20px); } }

        /* Accessibility: Th√™m outline khi focus v√†o c√°c ph·∫ßn t·ª≠ t∆∞∆°ng t√°c */
        .quiz-option, .quiz-choice-option, .lightbox-trigger-thumb, .btn, .nav-btn, .lang-btn, .recipe-item-content {
             outline: 2px solid transparent;
             outline-offset: 2px;
             transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .quiz-option:focus-visible, .quiz-choice-option:focus-visible, .lightbox-trigger-thumb:focus-visible, .btn:focus-visible, .nav-btn:focus-visible, .lang-btn:focus-visible, .recipe-item-content:focus-visible {
             outline-color: var(--primary-accent);
        }

        .quiz-option { background-color: rgba(0,0,0,0.03); border: 2px solid transparent; padding: 1.25rem; border-radius: 1.25rem; cursor: pointer; font-weight: 600; font-size: 1.1rem; text-align: center; }
        .quiz-option:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0,0,0,0.07); }
        .quiz-option.selected { border-color: var(--primary-accent); background-color: rgba(0, 122, 255, 0.1); color: var(--primary-accent); }
        
        .filter-btn { background-color: rgba(0,0,0,0.05); border: 1px solid transparent; transition: all 0.2s ease-in-out; }
        .filter-btn.active { background-color: rgba(0, 122, 255, 0.1); border-color: var(--primary-accent); color: var(--primary-accent); font-weight: 600; }
        
        .spinner { border: 3px solid rgba(0, 0, 0, 0.1); width: 20px; height: 20px; border-radius: 50%; border-left-color: currentColor; animation: spin 1s ease infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal { z-index: 50; transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; border-radius: 28px; }
        .modal.hidden { opacity: 0; pointer-events: none; }
        .modal.hidden .modal-content { transform: scale(0.95); }
        
        #comparisonModalContent { background-color: #f0f9ff; border-radius: 0 0 28px 28px; }
        .prose-comparison h3 { font-size: 1.5rem; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--text-primary); border-bottom: 2px solid var(--primary-accent); padding-bottom: 0.5rem; }

        .quiz-choice-option { cursor: pointer; background: rgba(255,255,255,0.7); border-radius: 20px;}
        .quiz-choice-option:hover { transform: scale(1.03); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }

        .overflow-y-auto::-webkit-scrollbar { width: 10px; }
        .overflow-y-auto::-webkit-scrollbar-track { background-color: transparent; }
        .overflow-y-auto::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 10px; border: 3px solid transparent; background-clip: content-box; }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.4); }
        .overflow-y-auto { scrollbar-width: auto; scrollbar-color: rgba(0, 0, 0, 0.2) transparent; }

        .chart-container { position: relative; margin: auto; height: 280px; width: 100%;}
        @media (min-width: 768px) { .chart-container { height: 320px; } }
        #colorChart, #bwChart { cursor: pointer; }
        
        #mobileNavMenu { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        #lightbox { z-index: 100; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
        #lightbox.hidden { opacity: 0; pointer-events: none; }
        #lightbox .lightbox-content { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #lightbox.hidden .lightbox-content { transform: scale(0.95); opacity: 0; }
        .lightbox-thumb { cursor: pointer; border: 2px solid transparent; }
        .lightbox-thumb.active { border-color: var(--primary-accent); transform: scale(1.05); box-shadow: 0 0 15px rgba(0, 122, 255, 0.5); }
        .lightbox-nav-btn { background-color: rgba(0,0,0,0.4); transition: background-color 0.2s ease; }
        .lightbox-nav-btn:hover { background-color: rgba(0,0,0,0.7); }
        #lightbox-main-image { transition: opacity 0.2s ease-in-out; }
        
        #abgm-grid-interactive-container {
            width: 100%;
            max-width: 300px;
            margin: auto;
            touch-action: none; 
        }
        #abgm-grid {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 0.5rem;
            cursor: pointer;
            background-image: 
                linear-gradient(to right, rgba(0, 128, 0, 0.2), rgba(255, 255, 255, 0), rgba(255, 0, 255, 0.2)),
                linear-gradient(to bottom, rgba(255, 165, 0, 0.2), rgba(255, 255, 255, 0), rgba(0, 0, 255, 0.2));
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
        }
        #abgm-pointer {
            position: absolute;
            width: 1rem;
            height: 1rem;
            background-color: #ef4444;
            border: 2px solid white;
            border-radius: 9999px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%);
            pointer-events: none;
        }
        .pp-infographic-item {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .pp-infographic-item h5 {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.125rem;
        }
        .pp-infographic-item .param-list li {
            position: relative;
            padding-left: 1.5rem;
        }
         .pp-infographic-item .param-list li::before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #16a34a;
            font-weight: bold;
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QKGB56ZKQD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QKGB56ZKQD');
    </script>
</head>
<body class="bg-slate-50">
    <div id="bg-blurs"><div class="blur-circle blur-1"></div><div class="blur-circle blur-2"></div></div>
    
    <div id="appContainer" class="min-h-screen w-screen p-4 md:p-6 flex flex-col">
        <!-- Maintainability: S·ª≠ d·ª•ng th·∫ª <header> cho ph·∫ßn ƒë·∫ßu trang -->
        <header class="flex justify-between items-center w-full z-20 flex-shrink-0">
            <!-- Accessibility: Th√™m aria-label cho n√∫t ch·ªâ c√≥ icon -->
            <button id="homeBtn" aria-label="Go to homepage" class="text-xl md:text-2xl font-bold text-gray-800 flex items-center gap-2">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 6.253v11.494m-5.747-8.662l11.494 5.747m-11.494 0l11.494-5.747M4.75 12A7.25 7.25 0 0112 4.75v0A7.25 7.25 0 0119.25 12v0a7.25 7.25 0 01-7.25 7.25v0A7.25 7.25 0 014.75 12v0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                <span data-translate-key="headerTitle" class="hidden sm:inline"></span>
                <span class="ml-2 text-[10px] font-bold text-white bg-gradient-to-r from-purple-500 via-blue-500 to-teal-400 px-2.5 py-1 rounded-full uppercase tracking-wider self-center shadow-md">Beta</span>
            </button>
            <div class="flex items-center gap-2 md:gap-4">
                <!-- Maintainability: S·ª≠ d·ª•ng th·∫ª <nav> cho khu v·ª±c ƒëi·ªÅu h∆∞·ªõng ch√≠nh -->
                <nav id="mainNav" class="hidden md:flex items-center gap-2" aria-label="Main navigation">
                    <div class="relative" id="pp-dropdown-container">
                        <button id="pp-dropdown-btn" class="font-semibold text-gray-600 hover:text-black transition-colors px-4 py-2 flex items-center gap-1 rounded-full hover:bg-gray-100" aria-haspopup="true" aria-expanded="false">
                            <span data-translate-key="navPictureProfile"></span>
                            <svg class="w-4 h-4 transition-transform" id="pp-dropdown-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="pp-dropdown-menu" class="absolute top-full mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-100 py-2 z-50 hidden origin-top-right transition-all duration-200 ease-out transform opacity-0 scale-95" role="menu">
                            <button role="menuitem" data-view="recipeFormulas" class="nav-btn text-left w-full px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-black" data-translate-key="navRecipeFormulas"></button>
                            <button role="menuitem" data-view="featuredPhotos" class="nav-btn text-left w-full px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-black" data-translate-key="navFeaturedPhotos"></button>
                            <button role="menuitem" data-view="explain" class="nav-btn text-left w-full px-4 py-2 text-gray-700 hover:bg-gray-100 hover:text-black" data-translate-key="navExplain"></button>
                        </div>
                    </div>
                    <div class="relative">
                        <button data-view="creativeLooks" class="nav-btn font-semibold text-gray-600 hover:text-black transition-colors px-4 py-2 rounded-full hover:bg-gray-100" data-translate-key="navCreativeLooks"></button>
                    </div>
                </nav>
                <div class="flex items-center gap-2">
                    <!-- Accessibility: Th√™m aria-label cho c√°c n√∫t ng√¥n ng·ªØ -->
                    <button id="langEN" class="lang-btn" aria-label="Switch to English"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30"><clipPath id="t"><path d="M30,15 h30 v15 z v15 h-30 z h-30 v-15 z v-15 h30 z"/></clipPath><path d="M0,0 v30 h60 v-30 z" fill="#00247d"/><path d="M0,0 L60,30 M60,0 L0,30" stroke="#fff" stroke-width="6"/><path d="M0,0 L60,30 M60,0 L0,30" clip-path="url(#t)" stroke="#cf142b" stroke-width="4"/><path d="M30,0 v30 M0,15 h60" stroke="#fff" stroke-width="10"/><path d="M30,0 v30 M0,15 h60" stroke="#cf142b" stroke-width="6"/></svg></button>
                    <button id="langVI" class="lang-btn" aria-label="Chuy·ªÉn sang ti·∫øng Vi·ªát"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 600"><path fill="#da251d" d="M0 0h900v600H0z"/><path fill="#ff0" d="m450 186-86 266 226-164h-280l226 164z"/></svg></button>
                </div>
                <!-- Accessibility: Th√™m aria-label cho n√∫t hamburger -->
                <button id="hamburgerBtn" class="md:hidden p-2 rounded-full hover:bg-black/10 focus:outline-none focus:ring-2 focus:ring-gray-500" aria-label="Open menu" aria-haspopup="true" aria-expanded="false">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </div>
        </header>
        
        <!-- Maintainability: S·ª≠ d·ª•ng th·∫ª <main> cho n·ªôi dung ch√≠nh c·ªßa trang -->
        <main id="mainContent" class="flex-grow min-h-0 relative mt-4 md:mt-6 mb-2"></main>
    </div>
    
    <div id="mobileNavMenu" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 transform translate-x-full md:hidden">
        <div class="absolute top-0 right-0 h-full w-2/3 max-w-sm bg-white/80 backdrop-blur-xl shadow-2xl p-6">
            <!-- Accessibility: Th√™m aria-label cho n√∫t ƒë√≥ng -->
            <button id="closeMobileNavBtn" class="absolute top-4 right-4 text-3xl p-2" aria-label="Close menu">&times;</button>
            <nav class="mt-16 flex flex-col gap-6 text-center" aria-label="Mobile navigation">
                <button data-view="recipeFormulas" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navRecipeFormulas"></button>
                <button data-view="creativeLooks" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navCreativeLooks"></button>
                <button data-view="featuredPhotos" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navFeaturedPhotos"></button>
                <button data-view="explain" class="nav-btn-mobile text-2xl font-semibold text-gray-700 py-2" data-translate-key="navExplain"></button>
            </nav>
        </div>
    </div>

    <div id="comparisonModal" class="modal hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50" role="dialog" aria-modal="true" aria-labelledby="comparisonModalTitle">
        <div class="modal-content glass-panel w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 md:p-6 border-b border-black/10 flex justify-between items-center flex-shrink-0">
                <h2 id="comparisonModalTitle" class="text-xl md:text-2xl font-bold"></h2>
                <!-- Accessibility: Th√™m aria-label cho n√∫t ƒë√≥ng -->
                <button id="closeComparisonModalBtn" class="text-3xl leading-none p-2 rounded-full hover:bg-black/10" aria-label="Close comparison modal">&times;</button>
            </div>
            <div id="comparisonModalContent" class="p-6 md:p-8 overflow-y-auto prose-comparison"></div>
        </div>
    </div>

    <div id="lightbox" class="hidden fixed inset-0 flex items-center justify-center p-4 transition-opacity duration-300" role="dialog" aria-modal="true">
        <div id="lightbox-bg" class="absolute inset-0"></div>
        <div class="lightbox-content relative w-full max-w-4xl max-h-full">
             <!-- Accessibility: Th√™m aria-label cho n√∫t ƒë√≥ng -->
            <button id="lightbox-close" class="absolute -top-4 -right-2 md:top-0 md:-right-12 text-white text-5xl font-bold z-10 leading-none p-2" aria-label="Close image viewer">&times;</button>
            <div class="relative">
                <!-- Accessibility: alt text s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS -->
                <img id="lightbox-main-image" src="" alt="·∫¢nh xem chi ti·∫øt" class="w-full h-auto max-h-[75vh] object-contain rounded-lg shadow-2xl bg-black/50">
                <!-- Accessibility: Th√™m aria-label cho c√°c n√∫t ƒëi·ªÅu h∆∞·ªõng -->
                <button id="lightbox-prev" class="lightbox-nav-btn absolute top-1/2 left-2 md:-left-16 -translate-y-1/2 p-2 md:p-3 rounded-full text-white" aria-label="Previous image">
                    <svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button id="lightbox-next" class="lightbox-nav-btn absolute top-1/2 right-2 md:-right-16 -translate-y-1/2 p-2 md:p-3 rounded-full text-white" aria-label="Next image">
                    <svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div id="lightbox-thumbnails" class="flex justify-center items-center gap-2 md:gap-4 mt-4"></div>
        </div>
    </div>

    <script type="module">
        // --- Code Quality: Th√™m comments ƒë·ªÉ ph√¢n chia c√°c khu v·ª±c logic ---
        // =================================================================
        // 1. STATE & CONFIGURATION
        // =================================================================
        const state = {
            currentLang: 'vi',
            currentView: 'home',
            selectedRecipeId: null,
            comparisonList: [],
            lastGeneratedAiRecipe: null,
            isAILoading: false,
            quizStep: 0,
            quizAnswers: {},
            activeFilters: { type: 'all', contrast: 'all', saturation: 'all' },
            isMobileDetailActive: false,
            lightbox: { isOpen: false, images: [], currentIndex: 0 }
        };

        const mainContentEl = document.getElementById('mainContent');
        let activeCharts = {};

        // Security: C·∫•u h√¨nh Marked.js ƒë·ªÉ lo·∫°i b·ªè HTML nguy hi·ªÉm.
        // Trong m·ªôt ·ª©ng d·ª•ng th·ª±c t·∫ø, n√™n s·ª≠ d·ª•ng m·ªôt th∆∞ vi·ªán chuy√™n d·ª•ng nh∆∞ DOMPurify.
        // marked.use({ renderer: new marked.Renderer(), gfm: true, breaks: false, pedantic: false });

        const translations = {
            // General
            headerTitle: {vi: "Alpha AI Color Lab", en: "Alpha AI Color Lab"},
            navPictureProfile: {vi: "Picture Profile", en: "Picture Profile"},
            navRecipeFormulas: {vi:"C√¥ng th·ª©c m√†u", en:"Color Recipes"},
            navCreativeLooks: {vi:"Creative Look", en:"Creative Look"},
            navFeaturedPhotos: {vi: "·∫¢nh n·ªïi b·∫≠t", en: "Featured Photos"},
            navExplain: {vi:"Gi·∫£i th√≠ch (PP)", en:"Guide (PP)"},
            noteTitle: {vi:"L∆∞u √Ω quan tr·ªçng", en:"Important Note"},
            footerText: {vi: "Ph√°t tri·ªÉn b·ªüi Sony Alpha Vietnam.", en: "Developed by Sony Alpha Vietnam."},

            // Home / Quiz
            landingTitle: {vi:"T√¨m m√†u s·∫Øc c·ªßa ri√™ng b·∫°n.", en:"Find Your Signature Color."},
            landingSubtitle: {vi:"Tr·∫£ l·ªùi v√†i c√¢u h·ªèi ƒë·ªÉ kh√°m ph√° c√¥ng th·ª©c m√†u ƒë∆∞·ª£c AI t·∫°o ra d√†nh ri√™ng cho t√¢m tr·∫°ng v√† phong c√°ch c·ªßa b·∫°n.", en:"Answer a few questions to discover a unique color recipe, tailored by AI to your mood and style."},
            startQuizBtn: {vi:"Kh√°m ph√° m√†u c·ªßa b·∫°n", en:"Discover Your Color"},
            quizResultTitle: {vi: "AI ƒë·ªÅ xu·∫•t 2 l·ª±a ch·ªçn cho b·∫°n:", en: "AI suggests 2 options for you:"},
            viewInLibraryBtn: {vi: "Xem trong th∆∞ vi·ªán", en: "View in Library"},
            loadingAnalyze: {vi: "ƒêang ph√¢n t√≠ch l·ª±a ch·ªçn...", en: "Analyzing your choices..."},
            
            // Recipe Formulas
            sidebarTitle: {vi: "C√¥ng th·ª©c Picture Profile", en: "Picture Profile Recipes"},
            searchInputPlaceholder: {vi: "üîç T√¨m c√¥ng th·ª©c...", en: "üîç Search recipes..."},
            filterType: {vi: "Lo·∫°i", en: "Type"},
            filterTypeColor: {vi: "M√†u", en: "Color"},
            filterTypeBW: {vi: "Tr·∫Øng ƒêen", en: "B&W"},
            filterContrast: {vi: "T∆∞∆°ng ph·∫£n", en: "Contrast"},
            filterSaturation: {vi: "B√£o h√≤a", en: "Saturation"},
            filterHigh: {vi: "Cao", en: "High"},
            filterMedium: {vi: "V·ª´a", en: "Med"},
            filterLow: {vi: "Th·∫•p", en: "Low"},
            filterSort: {vi: "S·∫Øp x·∫øp theo", en: "Sort by"},
            sortDefault: {vi: "M·∫∑c ƒë·ªãnh", en: "Default"},
            sortNameAZ: {vi: "T√™n A-Z", en: "Name A-Z"},
            sortContrastHL: {vi: "T∆∞∆°ng ph·∫£n: Cao-Th·∫•p", en: "Contrast: High-Low"},
            sortSaturationHL: {vi: "B√£o h√≤a: Cao-Th·∫•p", en: "Saturation: High-Low"},
            compareBtn: {vi: "So s√°nh b·∫±ng AI", en: "Compare with AI"},
            recipeDetailWelcomeTitle: {vi: "Th∆∞ vi·ªán m√†u T∆∞∆°ng t√°c", en: "Interactive Color Library"},
            recipeDetailWelcomeText: {vi: "Kh√°m ph√° c√°c c√¥ng th·ª©c m√†u Picture Profile m·ªôt c√°ch tr·ª±c quan. Nh·∫•p v√†o m·ªôt ƒëi·ªÉm tr√™n bi·ªÉu ƒë·ªì ho·∫∑c m·ªôt c√¥ng th·ª©c trong danh s√°ch ƒë·ªÉ xem chi ti·∫øt.", en: "Explore Picture Profile color recipes visually. Click a point on the chart or a recipe in the list to see details."},
            whiteBalanceTitle: {vi: "C√¢n b·∫±ng tr·∫Øng (WB)", en: "White Balance (WB)"},
            recipeSettingsTitle: {vi: "C√†i ƒë·∫∑t Ch√≠nh", en: "Main Settings"},
            colorDepthTitle: {vi: "ƒê·ªô s√¢u m√†u", en: "Color Depth"},
            detailTitle: {vi: "Chi ti·∫øt", en: "Detail"},
            aiTuningTitle: {vi: "Tinh ch·ªânh b·∫±ng AI", en: "AI Fine-Tuning"},
            aiTuningPlaceholder: {vi: "Nh·∫≠p y√™u c·∫ßu c·ªßa b·∫°n ·ªü ƒë√¢y... (v√≠ d·ª•: 'l√†m cho m√†u ·∫•m h∆°n v√† trong h∆°n')", en: "Enter your request here... (e.g., 'make it warmer and clearer')"},
            aiTuningBtn: {vi: "T·∫°o b·∫±ng AI", en: "Generate with AI"},
            aiResultTitle: {vi: "C√¥ng th·ª©c ƒë√£ ƒë∆∞·ª£c AI tinh ch·ªânh:", en: "AI-Adjusted Recipe:"},
            compareWithOriginalBtn: {vi: "So s√°nh v·ªõi b·∫£n g·ªëc", en: "Compare with Original"},
            aiSuggestionTitle: {vi: "G·ª£i √Ω c·ªßa AI:", en: "AI Suggestion:"},
            aiSuggestionText: {vi: "D·ª±a tr√™n y√™u c·∫ßu c·ªßa b·∫°n, c√¥ng th·ª©c n√†y c√≥ v·∫ª ph√π h·ª£p h∆°n: ", en: "Based on your request, this recipe might be a better fit: "},
            comparisonModalTitle: {vi: "So s√°nh C√¥ng th·ª©c", en: "Recipe Comparison"},
            comparisonLoading: {vi: "AI ƒëang ph√¢n t√≠ch v√† so s√°nh...", en: "AI is analyzing and comparing..."},
            colorChartTitle: {vi: "Bi·ªÉu ƒë·ªì M√†u", en: "Color Chart"},
            bwChartTitle: {vi: "Bi·ªÉu ƒë·ªì ƒê∆°n s·∫Øc (B&W)", en: "Monochrome (B&W) Chart"},
            axisTonality: {vi: "T∆∞∆°ng ph·∫£n (‚Üê M·ªÅm | C·ª©ng ‚Üí)", en: "Tonality (‚Üê Soft | Hard ‚Üí)"},
            axisSaturation: {vi: "ƒê·ªô b√£o h√≤a (‚Üê Th·∫•p | Cao ‚Üí)", en: "Saturation (‚Üê Low | High ‚Üí)"},
            axisChroma: {vi: "ƒê·ªô s√¢u m√†u (‚Üê Th·∫•p | Cao ‚Üí)", en: "Chroma Depth (‚Üê Low | High ‚Üí)"},
            backToListBtn: {vi: "‚Üê Quay l·∫°i danh s√°ch", en: "‚Üê Back to list"},

            // Featured Photos
            featuredTitle: {vi: "·∫¢nh N·ªïi B·∫≠t t·ª´ C·ªông ƒê·ªìng", en: "Featured Photos from the Community"},
            featuredCta: {vi: "C√πng nhau x√¢y d·ª±ng m·ªôt th∆∞ vi·ªán ·∫£nh ƒë·∫ßy c·∫£m h·ª©ng! H√£y chia s·∫ª nh·ªØng t√°c ph·∫©m b·∫°n ch·ª•p b·∫±ng c√°c c√¥ng th·ª©c t·ª´ Alpha AI Color Lab. ·∫¢nh ƒë∆∞·ª£c ch·ªçn s·∫Ω xu·∫•t hi·ªán t·∫°i ƒë√¢y ƒë·ªÉ vinh danh.", en: "Let's build an inspiring gallery together! Share your creations shot with recipes from the Alpha AI Color Lab. Selected photos will be featured here."},
            featuredAlbumBtn: {vi: "Xem Album & ƒê√≥ng g√≥p ·∫¢nh", en: "View Album & Contribute Photos"},
            contributeTitle: {vi: "Ho·∫∑c T·∫£i l√™n ·∫¢nh c·ªßa B·∫°n", en: "Or Upload Your Photo"},
            contributeDesc: {vi: "T·∫£i l√™n ·∫£nh c·ªßa b·∫°n ƒë·ªÉ chia s·∫ª ·∫©n danh. (Ch·ªâ mang t√≠nh minh ho·∫°, ·∫£nh s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u tr·ªØ).", en: "Upload your photo to share anonymously. (For demonstration purposes only, photos will not be saved)."},
            uploadBtn: {vi: "Ch·ªçn ·∫¢nh t·ª´ M√°y t√≠nh", en: "Choose Photo From Computer"},
            
            // Creative Looks
            creativeLookHeader: {vi: "Kh√°m Ph√° Creative Look", en: "Exploring Creative Looks"},
            creativeLookSubtitle: {vi: "T·∫°o n√™n th·∫ßn th√°i cho b·ª©c ·∫£nh ngay t·∫°i m√°y v·ªõi 10 tu·ª≥ ch·ªçn Creative Look c√≥ s·∫µn v√† kh·∫£ nƒÉng tu·ª≥ ch·ªânh s√¢u. ƒê√¢y l√† t√≠nh nƒÉng m·ªõi h∆°n so v·ªõi Creative Style tr√™n c√°c d√≤ng m√°y c≈©.", en: "Instantly create the mood for your photos in-camera with 10 pre-set Creative Looks and deep customization options. This is a newer feature compared to Creative Style on older models."},
            customParamsTitle: {vi: "C√°c th√¥ng s·ªë tu·ª≥ ch·ªânh", en: "Customizable Parameters"},
            recipeSuggestionsTitle: {vi: "C√¥ng th·ª©c G·ª£i √Ω", en: "Recipe Suggestions"},
            cl_base: {vi: "N·ªÅn", en: "Base"},
            cl_recipe_cinematic_name: {vi: "D√°ng v·∫ª ƒêi·ªán ·∫£nh", en: "Cinematic Look"},
            cl_recipe_cinematic_desc: {vi: "Gi·∫£m t∆∞∆°ng ph·∫£n v√† ƒë·ªô n√©t ƒë·ªÉ t·∫°o c·∫£m gi√°c m·ªÅm m·∫°i, ƒëi·ªán ·∫£nh.", en: "Reduces contrast and sharpness for a soft, cinematic feel."},
            cl_recipe_vibrant_name: {vi: "Phong c·∫£nh R·ª±c r·ª°", en: "Vibrant Landscape"},
            cl_recipe_vibrant_desc: {vi: "TƒÉng c∆∞·ªùng m√†u s·∫Øc v√† ƒë·ªô trong ƒë·ªÉ c·∫£nh v·∫≠t th√™m s·ªëng ƒë·ªông.", en: "Enhances color and clarity to make landscapes more vivid."},
            cl_recipe_soft_portrait_name: {vi: "Ch√¢n dung M·ªÅm m·∫°i", en: "Soft Portrait"},
            cl_recipe_soft_portrait_desc: {vi: "L√†m d·ªãu da v√† gi·∫£m t∆∞∆°ng ph·∫£n ƒë·ªÉ c√≥ m·ªôt b·ª©c ch√¢n dung n·ªãnh m·∫Øt.", en: "Softens skin and reduces contrast for a flattering portrait."},
            cl_recipe_teal_orange_name: {vi: "Ho√†i ni·ªám Xanh & Cam", en: "Teal & Orange Nostalgia"},
            cl_recipe_teal_orange_desc: {vi: "T·∫°o phong c√°ch ƒëi·ªán ·∫£nh hi·ªán ƒë·∫°i v·ªõi t√¥ng m√†u xanh ·ªü v√πng t·ªëi v√† cam ·ªü v√πng s√°ng.", en: "Creates a modern cinematic style with teal tones in the shadows and orange in the highlights."},
            cl_recipe_dramatic_mono_name: {vi: "K·ªãch t√≠nh ƒê∆°n s·∫Øc", en: "Dramatic Monochrome"},
            cl_recipe_dramatic_mono_desc: {vi: "·∫¢nh ƒëen tr·∫Øng t∆∞∆°ng ph·∫£n cao, v√πng t·ªëi s√¢u, ph√π h·ª£p ki·∫øn tr√∫c v√† ƒë∆∞·ªùng ph·ªë.", en: "High-contrast B&W with deep shadows, great for architecture and street."},
            cl_recipe_golden_hour_name: {vi: "√Ånh n·∫Øng M·∫≠t ong", en: "Golden Hour Glow"},
            cl_recipe_golden_hour_desc: {vi: "T√¥ng m√†u ·∫•m, m·ªÅm m·∫°i, t√°i t·∫°o √°nh s√°ng v√†ng √≥ng c·ªßa gi·ªù v√†ng.", en: "A warm, soft tone that recreates the golden light of the magic hour."},
            cl_recipe_urban_cool_name: {vi: "ƒê√¥ th·ªã L·∫°nh l√πng", en: "Urban Cool"},
            cl_recipe_urban_cool_desc: {vi: "M√†u l·∫°nh, h∆°i gi·∫£m b√£o ho√†, mang l·∫°i v·∫ª ƒë·∫πp hi·ªán ƒë·∫°i, s·∫°ch s·∫Ω cho c·∫£nh th√†nh ph·ªë.", en: "A cool, slightly desaturated look that brings a modern, clean feel to city scenes."},
            cl_recipe_vibrant_summer_name: {vi: "M√πa h√® R·ª±c r·ª°", en: "Vibrant Summer"},
            cl_recipe_vibrant_summer_desc: {vi: "TƒÉng c∆∞·ªùng ƒë·ªô b√£o ho√† c·ªßa c√°c m√†u n√≥ng, t·∫°o c·∫£m gi√°c nƒÉng ƒë·ªông, t∆∞∆°i vui c·ªßa m√πa h√®.", en: "Boosts the saturation of warm colors for an energetic, joyful summer vibe."},
            cl_ST_name: {vi: "ST: Ti√™u chu·∫©n", en:"ST: Standard"},
            cl_ST_desc: {vi: "M√†u ti√™u chu·∫©n cho ƒëa d·∫°ng ch·ªß th·ªÉ v√† b·ªëi c·∫£nh.", en:"The standard finish for a wide range of subjects and scenes."},
            cl_PT_name: {vi: "PT: Ch√¢n dung", en:"PT: Portrait"},
            cl_PT_desc: {vi: "T√°i t·∫°o t√¥ng m√†u da m·ªÅm m·∫°i, l√Ω t∆∞·ªüng cho ch·ª•p ch√¢n dung.", en:"For capturing skin in a soft tone, ideally suited for shooting portraits."},
            cl_NT_name: {vi: "NT: Trung t√≠nh", en:"NT: Neutral"},
            cl_NT_desc: {vi: "ƒê·ªô b√£o h√≤a v√† s·∫Øc n√©t th·∫•p h∆°n, ph√π h·ª£p cho ·∫£nh c·∫ßn h·∫≠u k·ª≥.", en:"Lower saturation and sharpness for shooting images before they are to be processed."},
            cl_VV_name: {vi: "VV: R·ª±c r·ª°", en:"VV: Vivid"},
            cl_VV_desc: {vi: "TƒÉng c∆∞·ªùng ƒë·ªô b√£o h√≤a v√† t∆∞∆°ng ph·∫£n ƒë·ªÉ t·∫°o ·∫•n t∆∞·ª£ng m·∫°nh.", en:"Saturation and contrast are heightened for a striking impression of colorful scenes and subjects."},
            cl_VV2_name: {vi: "VV2: R·ª±c r·ª° 2", en:"VV2: Vivid 2"},
            cl_VV2_desc: {vi: "T·∫°o ra ·∫£nh trong v√† s√°ng v·ªõi m√†u s·∫Øc s·ªëng ƒë·ªông. Hi·ªáu qu·∫£ v·ªõi ch·ªß th·ªÉ nhi·ªÅu m√†u s·∫Øc.", en:"Creates a highly clear image with bright and vibrant colours. Effective for colourful subjects."},
            cl_FL_name: {vi: "FL: Gi·∫£ l·∫≠p phim", en:"FL: Film-like"},
            cl_FL_desc: {vi: "T·∫°o c·∫£m gi√°c nh∆∞ phim ƒëi·ªán ·∫£nh v·ªõi m√†u s·∫Øc ƒëi·ªÅm tƒ©nh v√† b·∫ßu tr·ªùi ·∫•n t∆∞·ª£ng.", en:"For a film-like expression with calm colours and a stunning sky."},
            cl_IN_name: {vi: "IN: Ch·ª•p l·∫•y ngay", en:"IN: Instant Camera"},
            cl_IN_desc: {vi: "T·∫°o c·∫£m gi√°c ho√†i c·ªï nh∆∞ ·∫£nh ch·ª•p t·ª´ m√°y ·∫£nh l·∫•y li·ªÅn.", en:"For a nostalgic expression like photos from an instant camera."},
            cl_SH_name: {vi: "SH: Soft High-key", en:"SH: Soft High-key"},
            cl_SH_desc: {vi: "T·∫°o kh√¥ng kh√≠ trong tr·∫ªo, t∆∞∆°i s√°ng, m·ªÅm m·∫°i v√† nh·∫π nh√†ng.", en:"For creating a bright, transparent, soft, and gentle atmosphere."},
            cl_BW_name: {vi: "BW: ƒêen tr·∫Øng", en:"BW: Black & White"},
            cl_BW_desc: {vi: "T·∫°o ·∫£nh ƒë∆°n s·∫Øc kh√¥ng bao gi·ªù l·ªói th·ªùi.", en:"For creating a timeless Black & White image."},
            cl_SE_name: {vi: "SE: N√¢u ƒë·ªè", en:"SE: Sepia"},
            cl_SE_desc: {vi: "T·∫°o ·∫£nh m√†u n√¢u ƒë·ªè c·ªï ƒëi·ªÉn.", en:"For creating an archaic Sepia image."},
            cl_param_contrast: {vi: "T∆∞∆°ng ph·∫£n (Contrast)", en: "Contrast"},
            cl_param_contrast_desc: {vi: "Gi√° tr·ªã c√†ng cao, s·ª± kh√°c bi·ªát gi·ªØa v√πng s√°ng v√† t·ªëi c√†ng ƒë∆∞·ª£c nh·∫•n m·∫°nh.", en:"The higher the value, the more the difference between light and dark is emphasized."},
            cl_param_highlights: {vi: "V√πng s√°ng (Highlights)", en: "Highlights"},
            cl_param_highlights_desc: {vi: "ƒêi·ªÅu ch·ªânh ƒë·ªô s√°ng c·ªßa c√°c v√πng s√°ng.", en:"Adjusts the brightness of the bright areas."},
            cl_param_shadows: {vi: "V√πng t·ªëi (Shadows)", en: "Shadows"},
            cl_param_shadows_desc: {vi: "ƒêi·ªÅu ch·ªânh ƒë·ªô t·ªëi c·ªßa c√°c v√πng t·ªëi.", en:"Adjusts the darkness of the dark areas."},
            cl_param_fading: {vi: "ƒê·ªô b·∫°c m√†u (Fading)", en: "Fading"},
            cl_param_fading_desc: {vi: "Gi√° tr·ªã c√†ng cao, hi·ªáu ·ª©ng b·∫°c m√†u c√†ng r√µ r·ªát.", en:"The higher the value, the more the faded-out effect is applied."},
            cl_param_saturation: {vi: "B√£o h√≤a (Saturation)", en: "Saturation"},
            cl_param_saturation_desc: {vi: "Gi√° tr·ªã c√†ng cao, m√†u s·∫Øc c√†ng s·ªëng ƒë·ªông.", en:"The higher the value, the more vivid the colours."},
            cl_param_sharpness: {vi: "ƒê·ªô n√©t (Sharpness)", en: "Sharpness"},
            cl_param_sharpness_desc: {vi: "ƒêi·ªÅu ch·ªânh ƒë∆∞·ªùng vi·ªÅn. Gi√° tr·ªã c√†ng cao, ƒë∆∞·ªùng vi·ªÅn c√†ng ƒë∆∞·ª£c l√†m n·ªïi b·∫≠t.", en:"Adjusts the outline. The higher the value, the more the outlines are accentuated."},
            cl_param_sharpness_range: {vi: "Ph·∫°m vi n√©t (Sharpness Range)", en: "Sharpness Range"},
            cl_param_sharpness_range_desc: {vi: "ƒêi·ªÅu ch·ªânh ph·∫°m vi √°p d·ª•ng ƒë·ªô n√©t.", en:"Adjusts the range to which sharpness is applied."},
            cl_param_clarity: {vi: "ƒê·ªô trong (Clarity)", en: "Clarity"},
            cl_param_clarity_desc: {vi: "Gi√° tr·ªã c√†ng cao, ƒë·ªô trong c·ªßa ·∫£nh c√†ng ƒë∆∞·ª£c tƒÉng c∆∞·ªùng.", en:"The higher the value, the more the clarity is enhanced."},
            
            explainHeader: {vi: "L√†m Ch·ªß M√†u S·∫Øc C√πng Sony Alpha", en:"Mastering Color with Sony Alpha"},
            explainSubtitle: {vi: "H∆∞·ªõng d·∫´n to√†n di·ªán ƒë·ªÉ t·∫°o ra m√†u s·∫Øc ƒë·∫≠m ch·∫•t ri√™ng cho ·∫£nh tƒ©nh", en:"A comprehensive guide to creating your unique color signature for stills"},
            pillarsTitle: {vi: "Hai Tr·ª• C·ªôt S√°ng T·∫°o M√†u S·∫Øc", en:"The Two Pillars of Color Creation"},
            wbPillarTitle: {vi: "Tr·ª• c·ªôt 1: White Balance - N·ªÅn T·∫£ng C·∫£m X√∫c", en:"Pillar 1: White Balance - The Emotional Foundation"},
            ppPillarTitle: {vi: "Tr·ª• c·ªôt 2: Picture Profile - T·∫°o D√°ng V·∫ª Phim ·∫¢nh", en:"Pillar 2: Picture Profile - Crafting the Film Look"},
            wbKelvinTitle: {vi: "Nhi·ªát ƒê·ªô Kelvin (K): T·∫°o T√¥ng M√†u Ch·ªß ƒê·∫°o", en: "Kelvin Temperature (K): Creating the Main Tone"},
            wbKelvinDesc: {vi: 'S·ª≠ d·ª•ng thang ƒëo Kelvin nh∆∞ m·ªôt n√©t c·ªç l·ªõn ƒë·ªÉ "nhu·ªôm" to√†n b·ªô khung h√¨nh b·∫±ng t√¥ng m√†u ·∫•m ho·∫∑c l·∫°nh, ƒë·ªãnh h√¨nh "mood" cho b·ª©c ·∫£nh.', en: 'Use the Kelvin scale like a broad brush to "tint" the entire frame with warm or cool tones, shaping the photo\'s mood.'},
            wbShiftTitle: {vi: "L∆∞·ªõi Tinh Ch·ªânh (A-B/G-M Shift): Th√™m S·∫Øc Th√°i Tinh Vi", en:"Fine-Tuning Grid (A-B/G-M Shift): Adding Subtle Hues"},
            wbShiftDesc: {vi: 'N·∫øu Kelvin l√† n√©t c·ªç l·ªõn, l∆∞·ªõi tinh ch·ªânh l√† c·ªç t·ªâa. ƒê√¢y l√† ch√¨a kh√≥a ƒë·ªÉ m√¥ ph·ªèng c√°c lo·∫°i phim ƒë·∫∑c tr∆∞ng b·∫±ng c√°ch th√™m c√°c s·∫Øc th√°i H·ªï ph√°ch/Xanh ho·∫∑c Xanh l√°/T√≠m.', en: 'If Kelvin is the broad brush, this is the fine-detail brush. It\'s key to simulating specific films by adding Amber/Blue or Green/Magenta tints.'},
            ppInfographicTitle: {vi: "Quy tr√¨nh Tinh ch·ªânh Picture Profile", en:"Picture Profile Adjustment Workflow"},
            ppInfographicDesc: {vi: "L√†m theo c√°c b∆∞·ªõc sau ƒë·ªÉ thi·∫øt l·∫≠p Picture Profile t·ª´ ƒë·∫ßu, cho ph√©p b·∫°n ki·ªÉm so√°t ho√†n to√†n giao di·ªán cu·ªëi c√πng c·ªßa h√¨nh ·∫£nh.", en:"Follow these steps to set up a Picture Profile from scratch, giving you full control over the final look of your image."},
            ppItemBlackLevel: {vi: "Black Level (M·ª©c ƒë·ªô ƒëen)", en: "Black Level"},
            ppItemBlackLevelDesc: {vi: "Thi·∫øt l·∫≠p ƒëi·ªÉm ƒëen (v√πng t·ªëi nh·∫•t). TƒÉng (+) ƒë·ªÉ n√¢ng v√πng t·ªëi (t·∫°o look 'faded' ho√†i c·ªï), gi·∫£m (-) ƒë·ªÉ v√πng t·ªëi s√¢u h∆°n (tƒÉng t∆∞∆°ng ph·∫£n).", en: "Sets the black point. Increase (+) to lift shadows (for a 'faded' look), decrease (-) for deeper blacks (more contrast)."},
            ppItemGamma: {vi: "Gamma", en: "Gamma"},
            ppItemGammaDesc: {vi: "Thi·∫øt l·∫≠p ƒë∆∞·ªùng cong t∆∞∆°ng ph·∫£n (contrast curve). ƒê√¢y l√† n·ªÅn t·∫£ng cho 'look' c·ªßa b·∫°n. Still & Movie cho ƒë·ªô t∆∞∆°ng ph·∫£n cao, trong khi c√°c gamma Cine/S-Log cho d·∫£i nh·∫°y s√°ng r·ªông h∆°n.", en: "Sets the contrast curve. This is the foundation of your look. Still & Movie are punchy, while Cine/S-Log gammas offer wider dynamic range."},
            ppItemBlackGamma: {vi: "Black Gamma", en: "Black Gamma"},
            ppItemBlackGammaDesc: {vi: "Tinh ch·ªânh ƒë∆∞·ªùng cong t∆∞∆°ng ph·∫£n ·ªü v√πng t·ªëi. 'Wide' ·∫£nh h∆∞·ªüng v√πng r·ªông h∆°n, 'Narrow' ·∫£nh h∆∞·ªüng v√πng h·∫πp h∆°n.", en: "Fine-tunes the contrast curve in the shadow areas. 'Wide' affects a broader range, 'Narrow' affects a smaller range."},
            ppItemKnee: {vi: "Knee (ƒêi·ªÉm u·ªën)", en: "Knee"},
            ppItemKneeDesc: {vi: "Ki·ªÉm so√°t ƒë·ªô n√©n ·ªü v√πng s√°ng (highlight) ƒë·ªÉ tr√°nh b·ªã 'ch√°y'. Ch·∫ø ƒë·ªô t·ª± ƒë·ªông (Auto) ho·∫°t ƒë·ªông t·ªët, ch·∫ø ƒë·ªô th·ªß c√¥ng (Manual) cho ph√©p ki·ªÉm so√°t ch√≠nh x√°c h∆°n.", en: "Controls highlight compression to prevent 'clipping'. Auto mode works well; Manual mode gives precise control."},
            ppItemColorMode: {vi: "Color Mode (Ch·∫ø ƒë·ªô m√†u)", en: "Color Mode"},
            ppItemColorModeDesc: {vi: "X√°c ƒë·ªãnh c√°ch m√†u s·∫Øc ƒë∆∞·ª£c t√°i t·∫°o. N√™n ch·ªçn ch·∫ø ƒë·ªô ph√π h·ª£p v·ªõi Gamma ƒë√£ ch·ªçn (v√≠ d·ª•: Cine4 v·ªõi Pro/Cinema, S-Log3 v·ªõi S-Gamut3.Cine).", en: "Determines how colors are reproduced. Should be matched with the chosen Gamma (e.g., Cine4 with Pro/Cinema, S-Log3 with S-Gamut3.Cine)."},
            ppItemSaturation: {vi: "Saturation (B√£o h√≤a)", en: "Saturation"},
            ppItemSaturationDesc: {vi: "ƒêi·ªÅu ch·ªânh ƒë·ªô ƒë·∫≠m/nh·∫°t t·ªïng th·ªÉ c·ªßa t·∫•t c·∫£ c√°c m√†u.", en: "Adjusts the overall intensity of all colors."},
            ppItemColorPhase: {vi: "Color Phase (Pha m√†u)", en: "Color Phase"},
            ppItemColorPhaseDesc: {vi: "Xoay tr·ª•c m√†u s·∫Øc t·ªïng th·ªÉ. H·ªØu √≠ch ƒë·ªÉ tinh ch·ªânh nh·∫π to√†n b·ªô t√¥ng m√†u m√† kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn t·ª´ng m√†u ri√™ng l·∫ª.", en: "Shifts the overall hue of all colors. Useful for subtle, global color tone adjustments without affecting individual colors."},
            ppItemColorDepth: {vi: "Color Depth (ƒê·ªô s√¢u m√†u)", en: "Color Depth"},
            ppItemColorDepthDesc: {vi: "C√¥ng c·ª• m·∫°nh m·∫Ω nh·∫•t. TƒÉng/gi·∫£m ƒë·ªô s√°ng c·ªßa t·ª´ng k√™nh m√†u ri√™ng l·∫ª (ƒê·ªè, L·ª•c, Lam, L·ª•c lam, T√≠m, V√†ng).", en: "The most powerful tool. Increases/decreases the brightness of individual color channels (R, G, B, C, M, Y)."},
            ppItemDetail: {vi: "Detail (Chi ti·∫øt)", en: "Detail"},
            ppItemDetailDesc: {vi: "Ki·ªÉm so√°t ƒë·ªô s·∫Øc n√©t. ƒê·ªÉ c√≥ 'look' phim m·ªÅm m·∫°i, h√£y gi·∫£m m·∫°nh (v√≠ d·ª•: -7).", en: "Controls the sharpening. For a soft, filmic look, decrease it significantly (e.g., -7)."},
            recallTitle: { vi: 'L∆∞u Tr·ªØ & T√°i S·ª≠ D·ª•ng: L√†m Ch·ªß Memory Recall', en: 'Save & Reuse: Mastering Memory Recall' },
            recallDesc: { vi: 'ƒê·ª´ng l√£ng ph√≠ c√¥ng s·ª©c! L∆∞u l·∫°i c√°c c√¥ng th·ª©c c·ªßa b·∫°n v√†o b·ªô nh·ªõ c·ªßa m√°y ·∫£nh ƒë·ªÉ g·ªçi ra nhanh ch√≥ng ch·ªâ b·∫±ng m·ªôt thao t√°c xoay n√∫t.', en: 'Don\'t waste your effort! Save your recipes to the camera\'s memory for quick recall with a simple turn of a dial.' },
            recallInternalTitle: { vi: 'B·ªô Nh·ªõ Trong (1, 2, 3)', en: 'Internal Memory (1, 2, 3)' },
            recallInternalDesc: { vi: 'L∆∞u tr·ª±c ti·∫øp v√†o m√°y. Truy c·∫≠p nhanh nh·∫•t b·∫±ng c√°ch xoay v√≤ng xoay ch·∫ø ƒë·ªô. L√Ω t∆∞·ªüng cho c√°c c√¥ng th·ª©c b·∫°n s·ª≠ d·ª•ng h√†ng ng√†y.', en: 'Saves directly to the camera. Quickest access via the mode dial. Ideal for your daily-use recipes.' },
            recallCardTitle: { vi: 'Th·∫ª Nh·ªõ (M1, M2, M3, M4)', en: 'Memory Card (M1, M2, M3, M4)' },
            recallCardDesc: { vi: 'L∆∞u d∆∞·ªõi d·∫°ng file tr√™n th·∫ª nh·ªõ. C·ª±c k·ª≥ h·ªØu √≠ch ƒë·ªÉ sao l∆∞u an to√†n ho·∫∑c chuy·ªÉn c√¥ng th·ª©c sang m·ªôt th√¢n m√°y Sony kh√°c.', en: 'Saves as a file on your memory card. Extremely useful for backups or transferring recipes to another Sony camera body.' },
            tutorialTitle: { vi: "H∆∞·ªõng d·∫´n C√†i ƒë·∫∑t Nhanh", en: "Quick Setup Guide" },
            tutorialStep1Title: { vi: "B∆∞·ªõc 1: T√¨m Picture Profile", en: "Step 1: Find Picture Profile" },
            tutorialStep1P1: { vi: "<strong>M√°y ·∫£nh ƒë·ªùi m·ªõi:</strong> Menu ‚Üí Exposure/Color (bi·ªÉu t∆∞·ª£ng m√°y ·∫£nh) ‚Üí Color/Tone ‚Üí Picture Profile.", en: "<strong>Newer Cameras:</strong> Menu ‚Üí Exposure/Color (camera icon) ‚Üí Color/Tone ‚Üí Picture Profile." },
            tutorialStep1P2: { vi: "<strong>M√°y ·∫£nh ƒë·ªùi c≈©:</strong> Menu ‚Üí Color/WB/Img. Processing (bi·ªÉu t∆∞·ª£ng b·∫£ng m√†u) ‚Üí Picture Profile.", en: "<strong>Older Cameras:</strong> Menu ‚Üí Color/WB/Img. Processing (palette icon) ‚Üí Picture Profile." },
            tutorialStep2Title: { vi: "B∆∞·ªõc 2: Ch·ªçn v√† Reset", en: "Step 2: Select & Reset" },
            tutorialStep2P1: { vi: "Ch·ªçn m·ªôt profile tr·ªëng (v√≠ d·ª•: PP10), ƒëi v√†o trong v√† nh·∫•n n√∫t 'Xo√°' ƒë·ªÉ reset v·ªÅ m·∫∑c ƒë·ªãnh.", en: "Choose an empty profile (e.g., PP10), enter it, and press the 'Delete' button to reset it to default." },
            tutorialStep3Title: { vi: "B∆∞·ªõc 3: Nh·∫≠p th√¥ng s·ªë", en: "Step 3: Enter Parameters" },
            tutorialStep3P1: { vi: "C·∫©n th·∫≠n nh·∫≠p t·∫•t c·∫£ c√°c th√¥ng s·ªë c·ªßa c√¥ng th·ª©c, t·ª´ Black Level ƒë·∫øn Detail.", en: "Carefully enter all parameters from the recipe, from Black Level to Detail." },
            tutorialStep4Title: { vi: "B∆∞·ªõc 4: C√†i ƒë·∫∑t White Balance", en: "Step 4: Set White Balance" },
            tutorialStep4P1: { vi: "Tho√°t kh·ªèi Picture Profile, v√†o m·ª•c <strong>White Balance</strong> v√† ch·ªânh theo nhi·ªát ƒë·ªô K v√† WB Shift (Color Filter) ƒë∆∞·ª£c ghi trong c√¥ng th·ª©c.", en: "Exit Picture Profile, go to <strong>White Balance</strong>, and adjust the Kelvin temperature and WB Shift (Color Filter) as specified in the recipe." },
            exposureNoteTitle: { vi: "L∆∞u √Ω v·ªÅ Ph∆°i s√°ng", en: "Note on Exposure" },
            exposureNoteDesc: { vi: "H·∫ßu h·∫øt c√°c c√¥ng th·ª©c ƒë∆∞·ª£c t·ªëi ∆∞u khi ch·ª•p ·ªü m·ª©c ph∆°i s√°ng 0EV v·ªõi ch·∫ø ƒë·ªô ƒëo s√°ng 'To√†n m√†n h√¨nh trung b√¨nh' (Entire Screen Avg.). C√°c c√¥ng th·ª©c d·ª±a tr√™n S-Log c√≥ th·ªÉ c·∫ßn tƒÉng ph∆°i s√°ng (overexpose) ƒë·ªÉ c√≥ k·∫øt qu·∫£ t·ªët nh·∫•t.", en: "Most recipes are optimized for 0EV exposure with 'Entire Screen Avg.' metering mode. Recipes based on S-Log may require overexposure for best results." },

            // Quiz Questions
            quizQ1: {vi: "Gu th·∫©m m·ªπ c·ªßa b·∫°n?", en: "Your aesthetic?"},    
            quizQ1A1: {vi: "C·ªï ƒëi·ªÉn", en: "Classic"},    
            quizQ1A2: {vi: "Hi·ªán ƒë·∫°i", en: "Modern"},    
            quizQ1A3: {vi: "ƒêi·ªán ·∫£nh", en: "Cinematic"},    
            quizQ1A4: {vi: "Ngh·ªá thu·∫≠t", en: "Artistic"},
            quizQ2: {vi: "K·∫ø ho·∫°ch ch·ª•p h√¥m nay?", en: "Today's shoot plan?"},    
            quizQ2A1: {vi: "Ch√¢n dung", en: "Portraits"},    
            quizQ2A2: {vi: "Phong c·∫£nh", en: "Landscapes"},    
            quizQ2A3: {vi: "ƒê∆∞·ªùng ph·ªë", en: "Street"},    
            quizQ2A4: {vi: "ƒê·ªùi th∆∞·ªùng", en: "Everyday"},
            quizQ3: {vi: "T√¢m tr·∫°ng l√∫c n√†y?", en: "Current mood?"},    
            quizQ3A1: {vi: "Vui v·∫ª", en: "Happy"},    
            quizQ3A2: {vi: "Tr·∫ßm t∆∞", en: "Contemplative"},    
            quizQ3A3: {vi: "NƒÉng ƒë·ªông", en: "Dynamic"},    
            quizQ3A4: {vi: "B√¨nh y√™n", en: "Peaceful"},
            quizQ4: {vi: "B·∫°n th√≠ch du l·ªãch ƒë·∫øn ƒë√¢u?", en: "Where do you like to travel?"},
            quizQ4A1: {vi: "Bi·ªÉn xanh", en: "Beaches"},
            quizQ4A2: {vi: "N√∫i r·ª´ng", en: "Mountains"},
            quizQ4A3: {vi: "Th√†nh ph·ªë ƒë√¥ th·ªã", en: "Urban Cities"},
            quizQ4A4: {vi: "Ph·ªë c·ªï", en: "Old Towns"},
            quizQ5: {vi: "B·∫°n th√≠ch tone m√†u n√†o?", en: "Which color tone do you prefer?"},
            quizQ5A1: {vi: "Tone ·∫•m", en: "Warm Tones"},
            quizQ5A2: {vi: "Tone l·∫°nh", en: "Cool Tones"},
            quizQ5A3: {vi: "Trung t√≠nh", en: "Neutral"},
            quizQ6: {vi: "Xu h∆∞·ªõng h√¨nh ·∫£nh c·ªßa b·∫°n l√† g√¨?", en: "What is your image trend?"},
            quizQ6A1: {vi: "H∆°i th·ªü √Å ƒê√¥ng", en: "Eastern Vibe"},
            quizQ6A2: {vi: "C·∫£m h·ª©ng Ph∆∞∆°ng T√¢y", en: "Western Inspiration"},
            quizQ7: {vi: "B·∫°n th√≠ch ƒë·ªô t∆∞∆°ng ph·∫£n ra sao?", en: "How do you like the contrast?"},
            quizQ7A1: {vi: "Cao (G·∫Øt)", en: "High (Punchy)"},
            quizQ7A2: {vi: "Th·∫•p (M·ªÅm m·∫°i)", en: "Low (Soft)"},
            quizQ7A3: {vi: "Trung b√¨nh", en: "Medium"},
            quizQ8: {vi: "B·∫°n th√≠ch ƒë·ªô b√£o h√≤a m√†u s·∫Øc nh∆∞ th·∫ø n√†o?", en: "How do you like your color saturation?"},
            quizQ8A1: {vi: "Cao (R·ª±c r·ª°)", en: "High (Vibrant)"},
            quizQ8A2: {vi: "Th·∫•p (Nh·∫π nh√†ng)", en: "Low (Subtle)"},
            quizQ8A3: {vi: "Trung b√¨nh", en: "Medium"},
        };
        
        const quizQuestions = [
            { id: 'aesthetic', title: 'quizQ1', options: ['quizQ1A1', 'quizQ1A2', 'quizQ1A3', 'quizQ1A4'], values: ['Vintage', 'Modern', 'Cinematic', 'Artistic'] },
            { id: 'plan', title: 'quizQ2', options: ['quizQ2A1', 'quizQ2A2', 'quizQ2A3', 'quizQ2A4'], values: ['Portrait', 'Landscape', 'Street', 'Everyday'] },
            { id: 'mood', title: 'quizQ3', options: ['quizQ3A1', 'quizQ3A2', 'quizQ3A3', 'quizQ3A4'], values: ['Happy', 'Contemplative', 'Dynamic', 'Peaceful'] },
            { id: 'location', title: 'quizQ4', options: ['quizQ4A1', 'quizQ4A2', 'quizQ4A3', 'quizQ4A4'], values: ['Beach', 'Mountain', 'Urban', 'Old Town'] },
            { id: 'tone', title: 'quizQ5', options: ['quizQ5A1', 'quizQ5A2', 'quizQ5A3'], values: ['Warm', 'Cool', 'Neutral'] },
            { id: 'style', title: 'quizQ6', options: ['quizQ6A1', 'quizQ6A2'], values: ['Eastern', 'Western'] },
            { id: 'contrast', title: 'quizQ7', options: ['quizQ7A1', 'quizQ7A2', 'quizQ7A3'], values: ['High', 'Low', 'Medium'] },
            { id: 'saturation', title: 'quizQ8', options: ['quizQ8A1', 'quizQ8A2', 'quizQ8A3'], values: ['High', 'Low', 'Medium'] }
        ];
        
        // Maintainability: T√°ch d·ªØ li·ªáu ra kh·ªèi logic ch√≠nh.
        // Trong m·ªôt ·ª©ng d·ª•ng l·ªõn h∆°n, t·ªáp n√†y n√™n ƒë∆∞·ª£c t·∫£i t·ª´ m·ªôt t·ªáp JSON ri√™ng.


        // =================================================================
        // 2. API & DATA HANDLING
        // =================================================================

        /**
         * Simulates a call to an AI API.
         * @param {string} prompt - The prompt to send to the AI.
         * @param {number} delay - The simulated network delay in milliseconds.
         * @returns {Promise<any>} - The simulated AI response.
         */
        async function callAIApi(prompt, delay = 1000) {
            if (state.isAILoading) return;
            state.isAILoading = true;
            updateUIAfterAILoading(); // Show spinner immediately

            try {
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, delay));
                
                // Mock different API responses based on the prompt
                if (prompt.includes("Recommend TWO recipes")) {
                    const idx1 = Math.floor(Math.random() * recipesData.length);
                    let idx2 = Math.floor(Math.random() * recipesData.length);
                    while (idx1 === idx2) { idx2 = Math.floor(Math.random() * recipesData.length); }
                    const mockRecipe1 = recipesData[idx1]; 
                    const mockRecipe2 = recipesData[idx2];
                    return [
                        { recipeId: mockRecipe1.id, moodDescription: mockRecipe1.description[state.currentLang] },
                        { recipeId: mockRecipe2.id, moodDescription: mockRecipe2.description[state.currentLang] }
                    ];
                }
                if (prompt.includes("Original Recipe")) {
                    const originalId = prompt.match(/ID: (.*?)\)/)[1];
                    const originalRecipe = recipesData.find(r => r.id === originalId);
                    let adjustedRecipe = JSON.parse(JSON.stringify(originalRecipe));
                    adjustedRecipe.name = {vi: `${originalRecipe.name.vi} (AI Tinh ch·ªânh)`, en: `${originalRecipe.name.en} (AI Adjusted)`};
                    if (prompt.includes('·∫•m') || prompt.includes('warmer')) { adjustedRecipe.whiteBalance = "5500K, A6-M1"; }
                    if (prompt.includes('trong') || prompt.includes('clearer')) { if(adjustedRecipe.settings) adjustedRecipe.settings['Black level'] = '0'; }
                    return { recipe: adjustedRecipe };
                }
                if (prompt.includes("Compare the following two recipes")) {
                    const names = prompt.match(/\*(.*?)\* and \*(.*?)\*/);
                    return `### C·∫£m Gi√°c & Phong C√°ch\n* **${names[1]}:** Mang l·∫°i c·∫£m gi√°c ·∫•m √°p, ho√†i c·ªï.\n* **${names[2]}:** T·∫°o ra c√°i nh√¨n l·∫°nh h∆°n, hi·ªán ƒë·∫°i.\n\n### So S√°nh Th√¥ng S·ªë Ch√≠nh\n| Th√¥ng s·ªë | ${names[1]} | ${names[2]} | Ph√¢n T√≠ch |\n|---|---|---|---|\n| **White Balance** | ·∫§m (4000K) | L·∫°nh (8000K) | ƒê√¢y l√† s·ª± kh√°c bi·ªát ch√≠nh. |\n| **Black Level** | -15 | -10 | C·∫£ hai ƒë·ªÅu tƒÉng t∆∞∆°ng ph·∫£n, nh∆∞ng c√¥ng th·ª©c 1 c√≥ v√πng t·ªëi s√¢u h∆°n. |\n\n### Tr∆∞·ªùng H·ª£p S·ª≠ D·ª•ng\n* **D√πng ${names[1]} khi:** Ch·ª•p ch√¢n dung, ho√†ng h√¥n.\n* **D√πng ${names[2]} khi:** Ch·ª•p phong c·∫£nh, ki·∫øn tr√∫c.`;
                }
            } catch (error) {
                console.error("AI API call failed:", error); 
                return null;
            } finally {
                state.isAILoading = false;
                updateUIAfterAILoading(); // Hide spinner
            }
        }
        
        // =================================================================
        // 3. UTILITY & TRANSLATION FUNCTIONS
        // =================================================================

        /**
         * Gets the translation for a given key in the current language.
         * @param {string} key - The translation key.
         * @returns {string} - The translated string.
         */
        function t(key) { 
            return translations[key]?.[state.currentLang] || key; 
        }
        
        /**
         * Applies all translations to the current DOM.
         */
        function applyTranslations() {
            document.documentElement.lang = state.currentLang;
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (translations[key] && translations[key][state.currentLang]) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') { el.placeholder = t(key); }    
                    else if (el.tagName === 'OPTION') { el.textContent = t(key); }    
                    else { el.innerHTML = t(key); }
                }
            });
            document.querySelectorAll('.nav-btn-mobile').forEach(btn => {
                const key = 'nav' + btn.dataset.view.charAt(0).toUpperCase() + btn.dataset.view.slice(1);
                btn.textContent = t(key);
            });
            document.getElementById('langVI').classList.toggle('active', state.currentLang === 'vi');
            document.getElementById('langEN').classList.toggle('active', state.currentLang === 'en');
        }

        // =================================================================
        // 4. RENDER FUNCTIONS & VIEW TEMPLATES
        // =================================================================

        /**
         * Creates an HTML grid for recipe settings.
         * @param {object} settings - The settings object.
         * @returns {string} - The generated HTML string.
         */
        function createSettingsGrid(settings) {
            if (!settings) return '';
            return Object.entries(settings).map(([key, value]) => `<div class="flex flex-col"><span class="text-xs text-neutral-500">${key}</span><span class="font-semibold text-lg">${value}</span></div>`).join('');
        };

        /**
         * Creates the full HTML for a single recipe's details.
         * @param {object} recipe - The recipe object.
         * @param {boolean} isMainView - Flag for different styling.
         * @returns {string} - The generated HTML string.
         */
        function createFullRecipeHTML(recipe, isMainView = false) {
            const titleClass = isMainView ? 'text-xl font-bold' : 'text-lg font-bold';
            const noteHTML = (recipe.notes && recipe.notes[state.currentLang])    
                ? `<div class="mt-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-xl">
                            <p class="font-bold" data-translate-key="noteTitle"></p>
                            <p>${recipe.notes[state.currentLang]}</p>
                        </div>` : '';

            return `${noteHTML}<div class="space-y-6 mt-6">
                <div><h4 class="${titleClass} mb-2" data-translate-key="whiteBalanceTitle"></h4><div class="p-4 bg-black/5 rounded-xl"><p class="font-semibold text-lg">${recipe.whiteBalance || ''}</p></div></div>
                <div><h4 class="${titleClass} mb-2" data-translate-key="recipeSettingsTitle"></h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.settings)}</div></div>
                ${recipe.colorDepth ? `<div><h4 class="${titleClass} mb-2" data-translate-key="colorDepthTitle"></h4><div class="grid grid-cols-3 sm:grid-cols-6 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.colorDepth)}</div></div>` : ''}
                ${recipe.detailSettings ? `<div><h4 class="${titleClass} mb-2" data-translate-key="detailTitle"></h4><div class="grid grid-cols-2 sm:grid-cols-3 gap-x-6 gap-y-5 p-5 bg-black/5 rounded-xl">${createSettingsGrid(recipe.detailSettings)}</div></div>` : ''}
            </div>`;
        }

        /**
         * Updates UI elements that show a loading state.
         */
        function updateUIAfterAILoading() {
            document.querySelectorAll('button').forEach(btn => {
                if (state.isAILoading && btn.id === 'aiTuningBtn' && state.currentView === 'recipeFormulas' && state.selectedRecipeId) {
                    btn.disabled = true;
                    btn.dataset.originalText = btn.innerHTML;
                    btn.innerHTML = `<div class="spinner"></div> ${t('aiTuningBtn')}`;
                } else if (!state.isAILoading && btn.dataset.originalText) {
                    btn.innerHTML = btn.dataset.originalText;
                    btn.disabled = false;
                    delete btn.dataset.originalText;
                }
            });
        }
        
        // --- View Templates ---
        const viewTemplates = {
            home: () => `<div id="homeView" class="w-full h-full flex flex-col items-center justify-center text-center absolute inset-0 view-transition p-4">
                <h1 data-translate-key="landingTitle" class="landing-title"></h1>
                <p data-translate-key="landingSubtitle" class="landing-subtitle"></p>
                <button id="startQuizBtn" class="btn btn-primary mt-10 py-4 px-10 text-lg" data-translate-key="startQuizBtn"></button>
            </div>`,
            
            quiz: () => {
                if (state.quizStep >= quizQuestions.length) return '';
                const q = quizQuestions[state.quizStep];
                // Accessibility: Added role="button" and tabindex="0" to make divs keyboard-focusable
                const optionsHTML = q.options.map((optKey, index) => `<div class="quiz-option" data-value="${q.values[index]}" role="button" tabindex="0"><span data-translate-key="${optKey}"></span></div>`).join('');
                const gridCols = q.options.length > 2 ? 'grid-cols-2' : 'grid-cols-1 sm:grid-cols-2';
                return `<div id="quizView" class="w-full h-full flex flex-col items-center justify-center absolute inset-0 view-transition">
                    <div class="w-full max-w-4xl text-center px-4" data-quiz-group="${q.id}">
                        <h2 class="quiz-question-title" data-translate-key="${q.title}"></h2>
                        <div class="grid ${gridCols} gap-4 sm:gap-5 mt-10 sm:mt-12">${optionsHTML}</div>
                    </div>
                </div>`;
            },
            
            recipeFormulas: () => `
                <div id="recipeFormulasView" class="w-full h-full flex flex-col md:flex-row gap-6 absolute inset-0 view-transition">
                    <aside id="recipeListPanel" class="w-full md:w-1/3 lg:w-[30%] xl:w-1/4 glass-panel p-4 md:p-6 flex flex-col flex-shrink-0 md:flex">
                        <h2 class="text-2xl md:text-3xl font-bold" data-translate-key="sidebarTitle"></h2>
                        <input type="search" id="searchInput" class="w-full p-3 my-4 rounded-xl bg-gray-200/50 border-2 border-transparent focus:border-blue-500 focus:bg-white transition-all" data-translate-key="searchInputPlaceholder" aria-label="Search recipes">
                        <div id="filtersContainer" class="space-y-4 text-sm mb-4">
                            <div><h4 class="font-semibold mb-2" data-translate-key="filterType"></h4><div class="flex gap-2" data-filter-group="type"><button class="filter-btn flex-1 py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterTypeColor" data-filter-value="color"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterTypeBW" data-filter-value="bw"></button></div></div>
                            <div><h4 class="font-semibold mb-2" data-translate-key="filterContrast"></h4><div class="flex gap-2" data-filter-group="contrast"><button class="filter-btn flex-1 py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterHigh" data-filter-value="high"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterMedium" data-filter-value="medium"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterLow" data-filter-value="low"></button></div></div>
                            <div><h4 class="font-semibold mb-2" data-translate-key="filterSaturation"></h4><div class="flex gap-2" data-filter-group="saturation"><button class="filter-btn flex-1 py-2 px-3 rounded-full active" data-filter-value="all">All</button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterHigh" data-filter-value="high"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterMedium" data-filter-value="medium"></button><button class="filter-btn flex-1 py-2 px-3 rounded-full" data-translate-key="filterLow" data-filter-value="low"></button></div></div>
                        </div>
                        <div id="recipeListContainer" class="space-y-2 pt-4 border-t flex-grow overflow-y-auto pr-2 -mr-3"></div>
                        <div id="compareBtnContainer" class="pt-4 flex-shrink-0"></div>
                    </aside>
                    <section id="recipeMainPanel" class="w-full md:w-2/3 lg:w-[70%] xl:w-3/4 flex-col min-h-0 hidden md:flex" aria-labelledby="recipe-main-panel-heading">
                        <div class="glass-panel flex-grow overflow-y-auto p-6 lg:p-10">
                           <div id="chartsContainer">
                               <div class="text-center mb-10">
                                   <h2 id="recipe-main-panel-heading" class="text-2xl md:text-3xl font-bold text-gray-700" data-translate-key="recipeDetailWelcomeTitle"></h2><p class="text-neutral-500 mt-2 max-w-xl mx-auto" data-translate-key="recipeDetailWelcomeText"></p>
                               </div>
                               <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                   <div><h3 class="text-xl font-bold text-center mb-4" data-translate-key="colorChartTitle"></h3><div class="chart-container"><canvas id="colorChart"></canvas></div></div>
                                   <div><h3 class="text-xl font-bold text-center mb-4" data-translate-key="bwChartTitle"></h3><div class="chart-container"><canvas id="bwChart"></canvas></div></div>
                               </div>
                           </div>
                           <div id="recipeContent" class="hidden"></div>
                        </div>
                    </section>
                    <section id="recipeDetailPanelMobile" class="w-full h-full absolute inset-0 bg-[#f4f7fc] p-4 overflow-y-auto hidden" aria-label="Recipe details">
                        <button id="backToListBtn" class="btn bg-gray-200 text-gray-800 mb-4 p-4" data-translate-key="backToListBtn"></button>
                        <div class="glass-panel p-6 overflow-y-auto">
                           <div id="recipeContentMobile"></div>
                        </div>
                    </section>
                </div>`,
            
            creativeLooks: () => {
                const looks = ['ST', 'PT', 'NT', 'VV', 'VV2', 'FL', 'IN', 'SH', 'BW', 'SE'];
                const params = ['contrast', 'highlights', 'shadows', 'fading', 'saturation', 'sharpness', 'sharpness_range', 'clarity'];
                const creativeLookDetails = {
                    ST: { img: 'https://www.sony-asia.com/microsite/rmdc/creativelooks/wp-content/uploads/2024/12/ST-00000431.jpg' },
                    PT: { img: 'https://sony.scene7.com/is/image/sonyglobalsolutions/02_PT_sample1?$columnSlideShow$' },
                    NT: { img: 'https://sony.scene7.com/is/image/sonyglobalsolutions/03_NT_sample1?$columnSlideShow$' },
                    VV: { img: 'https://www.sony-asia.com/microsite/rmdc/creativelooks/wp-content/uploads/2024/08/DSC00213-2048x1536.jpg' },
                    VV2: { img: 'https://www.sony-asia.com/microsite/rmdc/creativelooks/wp-content/uploads/2024/06/VV2_SEL2450G_DSC00638_compressed-2048x1365.jpg' },
                    FL: { img: 'https://www.sony-asia.com/microsite/rmdc/creativelooks/wp-content/uploads/2024/06/FL_SEL2450G_DSC02112_compressed-2048x1365.jpg' },
                    IN: { img: 'https://www.sony-asia.com/microsite/rmdc/creativelooks/wp-content/uploads/2024/09/DSC01031-2048x1365.jpg' },
                    SH: { img: 'https://www.sony-asia.com/microsite/rmdc/creativelooks/wp-content/uploads/2024/08/jomnot_SH_01-2048x1365.jpg' },
                    BW: { img: 'https://www.sony-asia.com/microsite/rmdc/creativelooks/wp-content/uploads/2024/08/BW2-scaled.jpeg' },
                    SE: { img: 'https://www.sony-asia.com/microsite/rmdc/creativelooks/wp-content/uploads/2024/11/1-Satheeshan-Thiyagaraja_SE_-3-7-600433AWB-2048x1365.jpg' }
                };
                const suggestedRecipes = [
                    { nameKey: 'cl_recipe_cinematic_name', descKey: 'cl_recipe_cinematic_desc', base: 'FL', settings: { Contrast: -2, Highlights: -1, Shadows: +1, Fade: 2, Saturation: -1, Sharpness: -2, Clarity: 0 } },
                    { nameKey: 'cl_recipe_vibrant_name', descKey: 'cl_recipe_vibrant_desc', base: 'VV2', settings: { Contrast: +2, Highlights: 0, Shadows: 0, Fade: 0, Saturation: +3, Sharpness: +1, Clarity: +2 } },
                    { nameKey: 'cl_recipe_soft_portrait_name', descKey: 'cl_recipe_soft_portrait_desc', base: 'PT', settings: { Contrast: -3, Highlights: +1, Shadows: +2, Fade: 1, Saturation: 0, Sharpness: -4, Clarity: +1 } },
                    { nameKey: 'cl_recipe_teal_orange_name', descKey: 'cl_recipe_teal_orange_desc', base: 'FL', settings: { Contrast: +1, Highlights: -2, Shadows: +3, Fade: 3, Saturation: -2, Sharpness: -1, Clarity: 0 } },
                    { nameKey: 'cl_recipe_dramatic_mono_name', descKey: 'cl_recipe_dramatic_mono_desc', base: 'BW', settings: { Contrast: +5, Highlights: -2, Shadows: -4, Fade: 0, Saturation: 0, Sharpness: +3, Clarity: +2 } },
                    { nameKey: 'cl_recipe_golden_hour_name', descKey: 'cl_recipe_golden_hour_desc', base: 'ST', settings: { Contrast: -2, Highlights: 0, Shadows: +4, Fade: 2, Saturation: +2, Sharpness: -3, Clarity: 0 } },
                    { nameKey: 'cl_recipe_urban_cool_name', descKey: 'cl_recipe_urban_cool_desc', base: 'NT', settings: { Contrast: +2, Highlights: -1, Shadows: -2, Fade: 1, Saturation: -3, Sharpness: +2, Clarity: +1 } },
                    { nameKey: 'cl_recipe_vibrant_summer_name', descKey: 'cl_recipe_vibrant_summer_desc', base: 'VV2', settings: { Contrast: +1, Highlights: 0, Shadows: 0, Fade: 0, Saturation: +4, Sharpness: 0, Clarity: +3 } }
                ];

                // Performance: Th√™m loading="lazy" v√† onerror cho ·∫£nh
                const looksHTML = looks.map(look => `
                    <div class="bg-white rounded-xl shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform duration-300">
                        <img src="${creativeLookDetails[look].img}" alt="Creative Look ${look}" class="w-full h-48 object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e0e0e0/757575?text=Image+Not+Found';">
                        <div class="p-5">
                            <h4 class="font-bold text-lg" data-translate-key="cl_${look}_name"></h4>
                            <p class="text-sm text-gray-600 mt-1" data-translate-key="cl_${look}_desc"></p>
                        </div>
                    </div>`).join('');

                const paramsHTML = params.map(param => `
                    <div class="bg-blue-50/50 p-4 rounded-lg">
                        <h5 class="font-semibold text-blue-800" data-translate-key="cl_param_${param.replace('_', '')}"></h5>
                        <p class="text-sm text-blue-700/80" data-translate-key="cl_param_${param.replace('_', '')}_desc"></p>
                    </div>`).join('');

                const recipesHTML = suggestedRecipes.map(recipe => `
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                         <div class="p-5">
                            <h4 class="text-xl font-bold" data-translate-key="${recipe.nameKey}"></h4>
                            <p class="text-sm text-gray-600 mt-1 mb-4" data-translate-key="${recipe.descKey}"></p>
                            <div class="text-sm font-semibold text-white bg-blue-500 inline-block px-3 py-1 rounded-full mb-4"><span data-translate-key="cl_base"></span>: ${recipe.base}</div>
                            <ul class="text-sm space-y-2">
                                ${Object.entries(recipe.settings).map(([key, value]) => `
                                    <li class="flex justify-between items-center">
                                        <span class="text-gray-700">${key}</span>
                                        <span class="font-bold text-gray-900 bg-gray-100 px-2 py-0.5 rounded-md">${value > 0 ? '+' : ''}${value}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                `).join('');

                return `
                <div id="creativeLooksView" class="w-full h-full absolute inset-0 overflow-y-auto view-transition p-4 md:p-8">
                    <div class="max-w-7xl mx-auto">
                        <header class="text-center mb-10 md:mb-12">
                            <h1 class="text-3xl md:text-5xl font-extrabold text-slate-800 mb-2" data-translate-key="creativeLookHeader"></h1>
                            <p class="text-base md:text-lg text-slate-600 max-w-3xl mx-auto" data-translate-key="creativeLookSubtitle"></p>
                        </header>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${looksHTML}
                        </div>
                        
                        <section class="mt-12 md:mt-16">
                            <h3 class="text-2xl md:text-3xl font-bold text-center mb-8" data-translate-key="recipeSuggestionsTitle"></h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                ${recipesHTML}
                            </div>
                        </section>

                        <section class="mt-12 md:mt-16 bg-white rounded-2xl shadow-lg p-6 md:p-8">
                            <h3 class="text-2xl md:text-3xl font-bold text-center mb-8" data-translate-key="customParamsTitle"></h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-5">
                               ${paramsHTML}
                            </div>
                        </section>
                         <footer class="text-center text-sm text-gray-500 pt-8 mt-12 border-t">
                             <p data-translate-key="footerText"></p>
                         </footer>
                    </div>
                </div>`;
            },
            
            featuredPhotos: () => `<div id="featuredPhotosView" class="w-full h-full absolute inset-0 overflow-y-auto view-transition p-4">
                <div class="glass-panel p-6 md:p-12 text-center max-w-5xl mx-auto">
                    <h2 class="text-2xl md:text-4xl font-bold" data-translate-key="featuredTitle"></h2>
                    <p class="text-base md:text-lg text-neutral-600 mt-4 max-w-3xl mx-auto" data-translate-key="featuredCta"></p>
                    <a href="https://photos.app.goo.gl/H8v1SQ68RSnn2r5Q6" target="_blank" rel="noopener noreferrer" class="btn btn-primary mt-8 py-3 px-8 text-base md:text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 2L12 11M12 11L15 8M12 11L9 8"/><path d="M20 13.33V18C20 19.1046 19.1046 20 18 20H6C4.89543 20 4 19.1046 4 18V6C4 4.89543 4.89543 4 6 4H10.67" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        <span data-translate-key="featuredAlbumBtn"></span>
                    </a>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-10">
                        ${recipesData.slice(0,6).map((recipe) => {
                            const hasDemoImages = recipe.demoImages && recipe.demoImages.length > 0;
                            const imgSrc = hasDemoImages ? recipe.demoImages[0] : `https://placehold.co/800x600/${recipe.personalityColor.substring(1)}/ffffff?text=${encodeURIComponent(recipe.name[state.currentLang])}`;
                            return `<div class="bg-gray-200 group rounded-xl overflow-hidden cursor-pointer lightbox-trigger-thumb" data-recipe-id="${recipe.id}" data-index="0" role="button" tabindex="0" aria-label="View photo for ${recipe.name[state.currentLang]}">
                                <img src="${imgSrc}" alt="·∫¢nh demo c√¥ng th·ª©c ${recipe.name[state.currentLang]}" class="aspect-video w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/800x600/e0e0e0/757575?text=Image+Not+Found';">
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="mt-12 pt-10 border-t border-gray-900/10">
                      <h3 class="text-xl md:text-2xl font-bold" data-translate-key="contributeTitle"></h3>
                      <p class="text-neutral-600 mt-2 max-w-xl mx-auto" data-translate-key="contributeDesc"></p>
                      <label class="btn btn-secondary mt-6 py-3 px-8 bg-gray-200 text-black hover:bg-gray-300 cursor-pointer">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                          <span data-translate-key="uploadBtn"></span>
                          <input type="file" class="hidden" accept="image/jpeg, image/png" id="photoUploadInput">
                      </label>
                    </div>
                </div>
            </div>`,
            
            explain: () => `
            <div id="explainView" class="w-full h-full absolute inset-0 overflow-y-auto view-transition bg-slate-50 text-gray-800">
                <div class="container mx-auto p-4 sm:p-6 md:p-12">
                    <header class="text-center mb-12 md:mb-16 pt-4 md:pt-8">
                        <h1 class="text-3xl md:text-5xl font-extrabold text-slate-800 mb-2" data-translate-key="explainHeader"></h1>
                        <p class="text-lg md:text-xl text-slate-600 max-w-3xl mx-auto" data-translate-key="explainSubtitle"></p>
                    </header>
                
                    <div class="space-y-12 md:space-y-20">
                        <section class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                            <h3 class="text-2xl md:text-3xl font-bold text-center mb-8" data-translate-key="tutorialTitle"></h3>
                            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                                <div class="flex flex-col items-center">
                                    <div class="flex items-center justify-center w-16 h-16 bg-sky-100 text-sky-600 rounded-full text-2xl font-bold mb-4">1</div>
                                    <h4 class="font-bold text-lg mb-2" data-translate-key="tutorialStep1Title"></h4>
                                    <div class="text-sm text-gray-600 space-y-2">
                                        <p data-translate-key="tutorialStep1P1"></p>
                                        <p data-translate-key="tutorialStep1P2"></p>
                                    </div>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="flex items-center justify-center w-16 h-16 bg-sky-100 text-sky-600 rounded-full text-2xl font-bold mb-4">2</div>
                                    <h4 class="font-bold text-lg mb-2" data-translate-key="tutorialStep2Title"></h4>
                                    <p class="text-sm text-gray-600" data-translate-key="tutorialStep2P1"></p>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="flex items-center justify-center w-16 h-16 bg-sky-100 text-sky-600 rounded-full text-2xl font-bold mb-4">3</div>
                                    <h4 class="font-bold text-lg mb-2" data-translate-key="tutorialStep3Title"></h4>
                                    <p class="text-sm text-gray-600" data-translate-key="tutorialStep3P1"></p>
                                </div>
                                <div class="flex flex-col items-center">
                                    <div class="flex items-center justify-center w-16 h-16 bg-sky-100 text-sky-600 rounded-full text-2xl font-bold mb-4">4</div>
                                    <h4 class="font-bold text-lg mb-2" data-translate-key="tutorialStep4Title"></h4>
                                    <p class="text-sm text-gray-600" data-translate-key="tutorialStep4P1"></p>
                                </div>
                            </div>
                        </section>

                        <section>
                            <h3 class="text-2xl md:text-3xl font-bold text-center mb-8" data-translate-key="pillarsTitle"></h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                                    <h4 class="text-xl font-bold mb-6 text-center" data-translate-key="wbPillarTitle"></h4>
                                    <div class="mb-8">
                                        <h5 class="font-bold text-lg" data-translate-key="wbKelvinTitle"></h5>
                                        <p class="text-sm text-gray-600 mb-3" data-translate-key="wbKelvinDesc"></p>
                                        <div class="w-full h-8 rounded-full bg-gradient-to-r from-blue-400 via-white to-orange-400 flex justify-between items-center px-2 text-xs font-bold text-gray-700">
                                            <span>2500K</span>
                                            <span>5500K</span>
                                            <span>9900K</span>
                                        </div>
                                    </div>
                                    <div>
                                        <h5 class="font-bold text-lg" data-translate-key="wbShiftTitle"></h5>
                                        <p class="text-sm text-gray-600 mb-3" data-translate-key="wbShiftDesc"></p>
                                        <div id="abgm-grid-interactive-container">
                                            <div id="abgm-grid" class="relative">
                                                <span class="absolute top-1/2 -left-5 -translate-y-1/2 font-bold text-blue-600">B</span>
                                                <span class="absolute top-1/2 -right-5 -translate-y-1/2 font-bold text-amber-600">A</span>
                                                <span class="absolute left-1/2 -top-5 -translate-x-1/2 font-bold text-green-600">G</span>
                                                <span class="absolute left-1/2 -bottom-5 -translate-x-1/2 font-bold text-purple-600">M</span>
                                                <div id="abgm-pointer" style="top: 50%; left: 50%;"></div>
                                            </div>
                                            <div id="abgm-values" class="text-center mt-2 font-mono font-semibold bg-slate-100 p-2 rounded-md">A-B: 0, G-M: 0</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                                    <h4 class="text-xl font-bold mb-6 text-center" data-translate-key="ppPillarTitle"></h4>
                                    <p class="text-sm text-gray-700 mb-6 text-center" data-translate-key="ppInfographicDesc"></p>
                                    <div class="space-y-4">
                                        <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">1. <span data-translate-key="ppItemGamma"></span></summary><p class="text-sm text-gray-600 mt-2" data-translate-key="ppItemGammaDesc"></p></details>
                                        <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">2. <span data-translate-key="ppItemColorMode"></span></summary><p class="text-sm text-gray-600 mt-2" data-translate-key="ppItemColorModeDesc"></p></details>
                                        <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">3. <span data-translate-key="ppItemBlackLevel"></span></summary><p class="text-sm text-gray-600 mt-2" data-translate-key="ppItemBlackLevelDesc"></p></details>
                                        <details class="pp-infographic-item"><summary class="font-bold cursor-pointer">4. <span data-translate-key="ppItemColorDepth"></span></summary><p class="text-sm text-gray-600 mt-2" data-translate-key="ppItemColorDepthDesc"></p></details>
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        <section class="bg-gradient-to-b from-slate-100 to-white rounded-2xl shadow-lg p-6 md:p-8">
                           <h3 class="text-2xl md:text-3xl font-bold text-center" data-translate-key="ppInfographicTitle"></h3>
                           <p class="max-w-3xl mx-auto text-center text-gray-700 mt-2 mb-10" data-translate-key="ppInfographicDesc"></p>
                           <div class="space-y-6">
                                <div class="pp-infographic-item"><h5 data-translate-key="ppItemBlackLevel"></h5><p class="text-sm text-gray-600 mt-1" data-translate-key="ppItemBlackLevelDesc"></p></div>
                                <div class="text-center text-gray-400 font-bold">‚Üì</div>
                                <div class="pp-infographic-item"><h5 data-translate-key="ppItemGamma"></h5><p class="text-sm text-gray-600 mt-1" data-translate-key="ppItemGammaDesc"></p></div>
                                <div class="text-center text-gray-400 font-bold">‚Üì</div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="pp-infographic-item"><h5 data-translate-key="ppItemBlackGamma"></h5><p class="text-sm text-gray-600 mt-1" data-translate-key="ppItemBlackGammaDesc"></p></div>
                                    <div class="pp-infographic-item"><h5 data-translate-key="ppItemKnee"></h5><p class="text-sm text-gray-600 mt-1" data-translate-key="ppItemKneeDesc"></p></div>
                                </div>
                                <div class="text-center text-gray-400 font-bold">‚Üì</div>
                                <div class="pp-infographic-item"><h5 data-translate-key="ppItemColorMode"></h5><p class="text-sm text-gray-600 mt-1" data-translate-key="ppItemColorModeDesc"></p></div>
                                <div class="text-center text-gray-400 font-bold">‚Üì</div>
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div class="pp-infographic-item"><h5 data-translate-key="ppItemSaturation"></h5><p class="text-sm text-gray-600 mt-1" data-translate-key="ppItemSaturationDesc"></p></div>
                                    <div class="pp-infographic-item"><h5 data-translate-key="ppItemColorPhase"></h5><p class="text-sm text-gray-600 mt-1" data-translate-key="ppItemColorPhaseDesc"></p></div>
                                    <div class="pp-infographic-item"><h5 data-translate-key="ppItemDetail"></h5><p class="text-sm text-gray-600 mt-1" data-translate-key="ppItemDetailDesc"></p></div>
                                </div>
                                <div class="text-center text-gray-400 font-bold">‚Üì</div>
                                 <div class="pp-infographic-item"><h5 data-translate-key="ppItemColorDepth"></h5><p class="text-sm text-gray-600 mt-1" data-translate-key="ppItemColorDepthDesc"></p></div>
                           </div>
                           <div class="text-center mt-12">
                                <button id="exploreMoreBtn" class="btn btn-primary py-3 px-8 text-base md:text-lg" data-translate-key="navRecipeFormulas"></button>
                           </div>
                        </section>

                         <section class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                             <h3 class="text-2xl md:text-3xl font-bold text-center mb-4" data-translate-key="recallTitle"></h3>
                              <p class="max-w-3xl mx-auto text-center text-gray-700 mb-8" data-translate-key="recallDesc"></p>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                                 <div class="bg-slate-100 rounded-lg p-6 text-center">
                                     <h4 class="text-xl font-bold text-slate-700 mb-2" data-translate-key="recallInternalTitle"></h4>
                                     <p class="text-sm" data-translate-key="recallInternalDesc"></p>
                                 </div>
                                 <div class="bg-slate-100 rounded-lg p-6 text-center">
                                     <h4 class="text-xl font-bold text-slate-700 mb-2" data-translate-key="recallCardTitle"></h4>
                                     <p class="text-sm" data-translate-key="recallCardDesc"></p>
                                 </div>
                             </div>
                         </section>

                          <section class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
                             <h3 class="text-2xl md:text-3xl font-bold text-center mb-4" data-translate-key="exposureNoteTitle"></h3>
                              <p class="max-w-3xl mx-auto text-center text-gray-700" data-translate-key="exposureNoteDesc"></p>
                          </section>
                    
                    </div>
                    <footer class="text-center text-sm text-gray-500 pt-8 mt-12 border-t">
                        <p data-translate-key="footerText"></p>
                    </footer>
                </div>
            </div>`
        };


        // =================================================================
        // 5. EVENT HANDLERS & UI LOGIC
        // =================================================================

        /**
         * Opens the image lightbox.
         * @param {string[]} images - Array of image URLs.
         * @param {number} initialIndex - The index of the image to show first.
         */
        function openLightbox(images, initialIndex = 0) {
            if (!images || images.length === 0) return;
            state.lightbox.isOpen = true;
            state.lightbox.images = images;
            state.lightbox.currentIndex = initialIndex;
            const lightboxEl = document.getElementById('lightbox');
            lightboxEl.classList.remove('hidden');
            document.getElementById('lightbox-close').focus();
            updateLightboxContent();
        }

        /** Closes the image lightbox. */
        function closeLightbox() {
            state.lightbox.isOpen = false;
            document.getElementById('lightbox').classList.add('hidden');
        }

        /** Updates the content of the lightbox (main image and thumbnails). */
        function updateLightboxContent() {
            if (!state.lightbox.isOpen) return;
            const mainImageEl = document.getElementById('lightbox-main-image');
            const thumbnailsContainer = document.getElementById('lightbox-thumbnails');
            const newSrc = state.lightbox.images[state.lightbox.currentIndex];
            
            mainImageEl.style.opacity = '0';
            setTimeout(() => {
                mainImageEl.src = newSrc;
                mainImageEl.alt = `·∫¢nh xem chi ti·∫øt ${state.lightbox.currentIndex + 1}`;
                mainImageEl.onload = () => { mainImageEl.style.opacity = '1'; };
            }, 150);
            
            thumbnailsContainer.innerHTML = state.lightbox.images.map((imgSrc, index) => `
                <img src="${imgSrc}" class="lightbox-thumb w-16 h-16 md:w-20 md:h-20 object-cover rounded-md ${index === state.lightbox.currentIndex ? 'active' : ''}" data-index="${index}" alt="·∫¢nh thu nh·ªè ${index + 1}" role="button" tabindex="0">
            `).join('');
        }

        /**
         * Navigates the lightbox to the next or previous image.
         * @param {number} direction - 1 for next, -1 for previous.
         */
        function navigateLightbox(direction) {
            if (!state.lightbox.isOpen) return;
            const imageCount = state.lightbox.images.length;
            let newIndex = state.lightbox.currentIndex + direction;
            if (newIndex < 0) newIndex = imageCount - 1;
            else if (newIndex >= imageCount) newIndex = 0;
            state.lightbox.currentIndex = newIndex;
            updateLightboxContent();
        }

        /** Destroys all active Chart.js instances to prevent memory leaks. */
        function destroyAllCharts() {
            Object.values(activeCharts).forEach(chart => { if(chart && typeof chart.destroy === 'function') chart.destroy(); });
            activeCharts = {};
        }

        /** Initializes the interactive A-B/G-M grid in the 'Explain' view. */
        function initInteractiveGrid() {
            const grid = document.getElementById('abgm-grid');
            const pointer = document.getElementById('abgm-pointer');
            const valuesDisplay = document.getElementById('abgm-values');
            if (!grid || !pointer || !valuesDisplay) return;

            let isDragging = false;

            function updatePosition(clientX, clientY) {
                const rect = grid.getBoundingClientRect();
                let x = clientX - rect.left;
                let y = clientY - rect.top;

                x = Math.max(0, Math.min(x, rect.width));
                y = Math.max(0, Math.min(y, rect.height));

                pointer.style.left = `${x}px`;
                pointer.style.top = `${y}px`;

                const abValue = Math.round((x / rect.width) * 18 - 9);
                const gmValue = Math.round(((rect.height - y) / rect.height) * 18 - 9); 

                const abLabel = abValue > 0 ? `A${abValue}` : (abValue < 0 ? `B${Math.abs(abValue)}` : '0');
                const gmLabel = gmValue > 0 ? `G${gmValue}` : (gmValue < 0 ? `M${Math.abs(gmValue)}` : '0');

                valuesDisplay.textContent = `${abLabel}, ${gmLabel}`;
            }

            grid.addEventListener('mousedown', (e) => {
                isDragging = true;
                updatePosition(e.clientX, e.clientY);
            });
            
            grid.addEventListener('touchstart', (e) => {
                isDragging = true;
                updatePosition(e.touches[0].clientX, e.touches[0].clientY);
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) updatePosition(e.clientX, e.clientY);
            });
            
             document.addEventListener('touchmove', (e) => {
                if (isDragging) updatePosition(e.touches[0].clientX, e.touches[0].clientY);
            });

            document.addEventListener('mouseup', () => { isDragging = false; });
            document.addEventListener('touchend', () => { isDragging = false; });
        }

        /**
         * Renders a new view into the main content area with a transition.
         * @param {string} viewName - The name of the view to render.
         * @returns {Promise<void>}
         */
        function renderView(viewName) {
            return new Promise(resolve => {
                const currentContent = mainContentEl.children[0];
                if (currentContent) {
                    currentContent.classList.add('view-transition-out');
                    destroyAllCharts();
                    currentContent.addEventListener('animationend', () => {
                        mainContentEl.innerHTML = viewTemplates[viewName]();
                        state.currentView = viewName;
                        attachViewEventListeners(viewName);
                        applyTranslations();
                        resolve();
                    }, { once: true });
                } else {
                    mainContentEl.innerHTML = viewTemplates[viewName]();
                    state.currentView = viewName;
                    attachViewEventListeners(viewName);
                    applyTranslations();
                    resolve();
                }
            });
        }
        
        /** Handles clicks on the filter buttons. */
        function handleFilterClick(e) {
            const btn = e.target.closest('.filter-btn'); if (!btn) return;
            const group = btn.closest('[data-filter-group]').dataset.filterGroup;
            const value = btn.dataset.filterValue; state.activeFilters[group] = value;
            document.querySelectorAll(`[data-filter-group="${group}"] .filter-btn`).forEach(b => b.classList.remove('active'));
            btn.classList.add('active'); renderLibraryList();
        }

        /**
         * Handles recipe selection from the list or chart.
         * @param {string} id - The ID of the selected recipe.
         * @param {string} type - The type of interaction ('checkbox', 'div', 'chart').
         */
        function handleRecipeSelection(id, type) {
            if (type === 'checkbox') {
                const index = state.comparisonList.indexOf(id);
                if (index > -1) { state.comparisonList.splice(index, 1); } 
                else if (state.comparisonList.length < 2) { state.comparisonList.push(id); }
            } else {
                if (state.selectedRecipeId === id) {
                    state.selectedRecipeId = null;
                    state.isMobileDetailActive = false;
                } else {
                    state.selectedRecipeId = id;
                    state.isMobileDetailActive = true;
                }
                state.comparisonList = [];
            }
            renderLibraryList();
            renderLibraryDetails();
            
            if (activeCharts.color && typeof activeCharts.color.update === 'function') { activeCharts.color.update(); }
            if (activeCharts.bw && typeof activeCharts.bw.update === 'function') { activeCharts.bw.update(); }
        }

        /**
         * Handles the AI comparison between two recipes.
         * @param {string} id1 - ID of the first recipe.
         * @param {string} id2 - ID of the second recipe.
         * @param {object|null} recipe2Obj - An optional recipe object for comparison.
         */
        async function handleAiComparison(id1, id2, recipe2Obj = null) {
            const modal = document.getElementById('comparisonModal');
            const titleEl = document.getElementById('comparisonModalTitle');
            const contentEl = document.getElementById('comparisonModalContent');
            modal.classList.remove('hidden');
            titleEl.textContent = t('comparisonModalTitle');
            contentEl.innerHTML = `<div class="flex items-center justify-center p-8"><div class="spinner !w-12 !h-12 !border-4"></div><p class="ml-4 text-lg font-semibold">${t('comparisonLoading')}</p></div>`;
            const recipe1 = recipesData.find(r => r.id === id1);
            const recipe2 = recipe2Obj ? { ...recipe2Obj, id: 'ai-adjusted', name: recipe2Obj.name } : recipesData.find(r => r.id === id2);
            const prompt = `Compare the following two recipes: *${recipe1.name[state.currentLang]}* and *${recipe2.name[state.currentLang]}*. Analyze their overall feel, key parameter differences (like White Balance and Black Level), and suggest ideal use cases for each. Present the result in Markdown.`;
            const comparisonText = await callAIApi(prompt, 1200);
            
            // Security: Sanitize the HTML from Markdown before rendering.
            // In a real app, use a library like DOMPurify: DOMPurify.sanitize(marked.parse(...))
            contentEl.innerHTML = marked.parse(comparisonText || "Error loading comparison.");
            applyTranslations();
        }

        /** Handles the AI adjustment request. */
        async function handleAiAdjustment(button) {
            const recipeId = button.dataset.recipeId;
            const textarea = document.getElementById('aiTuningTextarea');
            const resultContainer = document.getElementById('aiResultContainer');
            if (!textarea.value || !resultContainer || state.isAILoading) return;
            
            const originalRecipe = recipesData.find(r => r.id === recipeId);
            const prompt = `Original Recipe (ID: ${recipeId}): ${JSON.stringify(originalRecipe.settings)}. User request: "${textarea.value}". Please provide a new JSON object with adjusted settings.`;
            const aiResponse = await callAIApi(prompt);
            
            if (aiResponse && aiResponse.recipe) {
                state.lastGeneratedAiRecipe = aiResponse.recipe;
                resultContainer.innerHTML = `<div class="mt-6 border-t border-gray-200/50 pt-6"><h4 class="font-bold text-lg mb-2">${state.lastGeneratedAiRecipe.name[state.currentLang]}</h4><div class="p-4 rounded-xl bg-blue-50">${createFullRecipeHTML(state.lastGeneratedAiRecipe, false)}</div><button id="compareWithOriginalBtn" data-original-id="${recipeId}" class="btn btn-secondary w-full mt-4 py-3 bg-gray-200 text-black" data-translate-key="compareWithOriginalBtn"></button></div>`;
            } else { resultContainer.innerHTML = `<p class="text-red-500">Failed to generate adjustment.</p>`; }
            applyTranslations();
        }

        /** Handles the submission of the quiz. */
        async function handleQuizSubmit() {
            await renderView('home');
            const homeView = document.getElementById('homeView');
            if (!homeView) { console.error("Quiz Submit Error: homeView not found after render."); return; }
            homeView.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><div class="spinner !w-16 !h-16 !border-4"></div><h2 class="landing-title mt-8" data-translate-key="loadingAnalyze"></h2></div>`;
            applyTranslations();
            const prompt = `Based on user preferences: ${JSON.stringify(state.quizAnswers)}. Recommend TWO recipes from the available list. Respond with JSON array: [{"recipeId", "moodDescription" (in ${state.currentLang})}, ...].`;
            const aiResponse = await callAIApi(prompt);
            if (aiResponse && aiResponse.length >= 2) {
                const r1 = recipesData.find(r => r.id === aiResponse[0].recipeId);
                const r2 = recipesData.find(r => r.id === aiResponse[1].recipeId);
                if (r1 && r2) {
                    homeView.innerHTML = `<div class="w-full h-full flex items-center justify-center absolute inset-0 view-transition"><div class="quiz-result-container p-6 md:p-8 rounded-3xl w-full max-w-5xl mx-auto glass-panel"><h3 class="text-2xl md:text-3xl font-bold mb-6 md:mb-8 text-center" data-translate-key="quizResultTitle"></h3><div class="grid md:grid-cols-2 gap-6"><div class="quiz-choice-option p-6" data-recipe-id="${r1.id}" role="button" tabindex="0"><h4 class="text-xl md:text-2xl font-bold mb-2">${r1.name[state.currentLang]}</h4><p class="text-base italic text-gray-600">"${r1.description[state.currentLang]}"</p></div><div class="quiz-choice-option p-6" data-recipe-id="${r2.id}" role="button" tabindex="0"><h4 class="text-xl md:text-2xl font-bold mb-2">${r2.name[state.currentLang]}</h4><p class="text-base italic text-gray-600">"${r2.description[state.currentLang]}"</p></div></div></div></div>`;
                    applyTranslations();
                }
            } else { homeView.innerHTML = `<p class="text-red-500">L·ªói khi l·∫•y ƒë·ªÅ xu·∫•t t·ª´ AI.</p>`; }
        }
        
        /** Attaches specific event listeners for the current view. */
        function attachViewEventListeners(viewName) {
            if (viewName === 'recipeFormulas') {
                renderLibraryList();  
                renderLibraryDetails();
                renderInteractiveCharts(state.currentLang);
            } else if (viewName === 'explain') {
                initInteractiveGrid();
            }
        }

        /** Renders the list of recipes based on current filters and search term. */
        function renderLibraryList() {
            const container = document.getElementById('recipeListContainer'); if (!container) return;
            const searchTerm = (document.getElementById('searchInput')?.value || '').toLowerCase();
            let recipesToRender = recipesData.filter(recipe => (recipe.name.vi.toLowerCase().includes(searchTerm) || recipe.name.en.toLowerCase().includes(searchTerm) || recipe.description.vi.toLowerCase().includes(searchTerm) || recipe.description.en.toLowerCase().includes(searchTerm)) && (state.activeFilters.type === 'all' || recipe.type === state.activeFilters.type) && (state.activeFilters.contrast === 'all' || recipe.contrast === state.activeFilters.contrast) && (state.activeFilters.saturation === 'all' || recipe.saturation === state.activeFilters.saturation) );
            
            container.innerHTML = recipesToRender.map(recipe => {
                const isChecked = state.comparisonList.includes(recipe.id);
                const isSelected = recipe.id === state.selectedRecipeId;

                return `<div class="recipe-item p-3 rounded-xl transition-all duration-200 border-l-4 border-transparent flex items-start gap-4 ${isSelected ? 'selected' : ''}">
                            <input type="checkbox" class="recipe-compare-cb form-checkbox h-5 w-5 text-blue-600 rounded-md border-gray-300 focus:ring-blue-500 self-start mt-1 flex-shrink-0" data-recipe-id="${recipe.id}" ${isChecked ? 'checked' : ''} ${state.comparisonList.length >= 2 && !isChecked ? 'disabled' : ''} aria-label="Select ${recipe.name[state.currentLang]} for comparison">
                             <div class="flex-grow cursor-pointer recipe-item-content" data-recipe-id="${recipe.id}" role="button" tabindex="0">
                                <div class="flex items-start gap-3">
                                   <div class="recipe-dot w-5 h-5 rounded-full flex-shrink-0 mt-1" style="background-color: ${recipe.personalityColor}" title="${recipe.name[state.currentLang]}"></div>
                                   <div class="flex-grow">
                                       <span class="font-semibold text-primary">${recipe.name[state.currentLang]}</span>
                                       <p class="text-sm text-neutral-600 mt-1 leading-snug">${recipe.description[state.currentLang]}</p>
                                   </div>
                                </div>
                            </div>
                        </div>`;
            }).join('');

            const btnContainer = document.getElementById('compareBtnContainer');
            btnContainer.innerHTML = `<button id="compareBtn" class="btn btn-primary w-full mt-4 py-3" data-translate-key="compareBtn" ${state.comparisonList.length !== 2 ? 'disabled' : ''}></button>`;
            applyTranslations();
        }
        
        /** Renders the recipe details panel, handling mobile and desktop views. */
        function renderLibraryDetails() {
            const isMobile = window.innerWidth < 768;
            const recipeListPanel = document.getElementById('recipeListPanel');
            const recipeMainPanel = document.getElementById('recipeMainPanel');
            const recipeDetailPanelMobile = document.getElementById('recipeDetailPanelMobile');

            if (isMobile) {
                if(state.isMobileDetailActive) {
                    recipeListPanel.classList.add('hidden');
                    recipeDetailPanelMobile.classList.remove('hidden');
                } else {
                    recipeListPanel.classList.remove('hidden');
                    recipeDetailPanelMobile.classList.add('hidden');
                }
            } else {
                recipeListPanel?.classList.remove('hidden');
                recipeDetailPanelMobile?.classList.add('hidden');
            }

            const recipe = recipesData.find(r => r.id === state.selectedRecipeId);

            let recipeContentContainer, chartsContainer;
            if (isMobile && state.isMobileDetailActive) {
                recipeContentContainer = document.getElementById('recipeContentMobile');
                chartsContainer = null;
            } else {
                recipeContentContainer = document.getElementById('recipeContent');
                chartsContainer = document.getElementById('chartsContainer');
            }

            if (!recipeContentContainer) return;

            if (!recipe) {  
                if (chartsContainer) chartsContainer.classList.remove('hidden');
                recipeContentContainer.classList.add('hidden');
                if(!isMobile) recipeMainPanel?.classList.remove('hidden');
                return;   
            }
            if (chartsContainer) chartsContainer.classList.add('hidden');
            recipeContentContainer.classList.remove('hidden');
            if(!isMobile) recipeMainPanel?.classList.remove('hidden');
            
            let thumbnailsHTML = '';
            const images = recipe.demoImages || [];
            let imageElements = [];
            images.forEach((imgSrc, index) => {
                imageElements.push(`<div class="bg-gray-200 group rounded-xl overflow-hidden cursor-pointer lightbox-trigger-thumb" data-recipe-id="${recipe.id}" data-index="${index}" role="button" tabindex="0"><img src="${imgSrc}" alt="·∫¢nh demo ${index + 1}" class="aspect-[4/3] w-full h-full object-cover transform group-hover:scale-105 transition-transform duration-300" loading="lazy"></div>`);
            });
            const placeholdersNeeded = 3 - imageElements.length;
            const placeholderColor = recipe.personalityColor ? recipe.personalityColor.substring(1) : 'cccccc';
            for (let i = 0; i < placeholdersNeeded; i++) {
                const placeholderIndex = images.length + i;
                 imageElements.push(`<div class="bg-gray-200 group rounded-xl overflow-hidden"><img src="https://placehold.co/400x300/${placeholderColor}/ffffff?text=Sample+${placeholderIndex + 1}" alt="·∫¢nh minh h·ªça ${placeholderIndex + 1}" class="aspect-[4/3] w-full h-full object-cover"></div>`);
            }
            thumbnailsHTML = `<div class="my-6"><div class="grid grid-cols-3 gap-2 md:gap-4">${imageElements.join('')}</div></div>`;

            recipeContentContainer.innerHTML = `
                <h3 class="text-3xl md:text-4xl font-bold">${recipe.name[state.currentLang]}</h3>
                <p class="text-lg text-neutral-600 mt-2 italic">"${recipe.description[state.currentLang]}"</p>
                ${thumbnailsHTML}
                <div id="originalRecipeContainer" class="mt-8">${createFullRecipeHTML(recipe, true)}</div>
                <div class="mt-12 pt-8 border-t-2 border-gray-200/60">
                    <details open class="group">
                        <summary class="text-xl md:text-2xl font-bold cursor-pointer list-none flex justify-between items-center group-hover:text-blue-600 transition-colors">
                            <span data-translate-key="tutorialTitle"></span>
                            <svg class="w-6 h-6 transition-transform transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </summary>
                        <div class="prose max-w-none mt-6 space-y-4 text-base text-gray-700">
                            <div><h4 class="font-bold" data-translate-key="tutorialStep1Title"></h4><p data-translate-key="tutorialStep1P1"></p></div>
                            <div><h4 class="font-bold" data-translate-key="tutorialStep2Title"></h4><p data-translate-key="tutorialStep2P1"></p></div>
                            <div><h4 class="font-bold" data-translate-key="tutorialStep3Title"></h4><p data-translate-key="tutorialStep3P1"></p></div>
                            <div><h4 class="font-bold" data-translate-key="tutorialStep4Title"></h4><p data-translate-key="tutorialStep4P1"></p></div>
                        </div>
                    </details>
                </div>
                <div class="mt-12 pt-8 border-t-2 border-gray-200/60">
                    <h3 class="text-xl md:text-2xl font-bold mb-4" data-translate-key="aiTuningTitle"></h3>
                    <div class="glass-panel p-4 md:p-6 -mx-2">
                        <textarea id="aiTuningTextarea" class="w-full p-3 rounded-lg border-2 border-gray-200 focus:ring-2 focus:ring-blue-500 transition-shadow" rows="3" data-translate-key="aiTuningPlaceholder"></textarea>
                        <button id="aiTuningBtn" data-recipe-id="${recipe.id}" class="btn btn-primary w-full mt-4 py-3" data-translate-key="aiTuningBtn"></button>
                        <div id="aiResultContainer"></div>
                    </div>
                </div>`;
            applyTranslations();
        }

        /** Renders the interactive scatter charts. */
        function renderInteractiveCharts(lang) {
            destroyAllCharts();
            const chartDefaultOptions = (yAxisTitleKey) => ({
                responsive: true,
                maintainAspectRatio: false,
                onClick: (e) => {
                    const chart = e.chart;
                    const elements = chart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                    if (elements.length) {
                        const firstPoint = elements[0];
                        const recipeId = chart.data.datasets[firstPoint.datasetIndex].data[firstPoint.index].id;
                        if (recipeId) { handleRecipeSelection(recipeId, 'chart'); }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleFont: { size: 14 },
                        bodyFont: { size: 13 },
                        padding: 10,
                        callbacks: { label: function(context) { return context.raw.name; } }
                    }
                },
                scales: {
                    x: { min: -10, max: 10, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { display: false }, border: { dash: [4, 4] }, title: { display: true, text: t('axisTonality') } },
                    y: { min: -10, max: 10, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { display: false }, border: { dash: [4, 4] }, title: { display: true, text: t(yAxisTitleKey) } }
                }
            });
            
            const colorCtx = document.getElementById('colorChart')?.getContext('2d');
            if (colorCtx) {
                const colorData = recipesData.filter(r => r.type === 'color' && r.coords && typeof r.coords.x === 'number' && typeof r.coords.y === 'number' && r.personalityColor).map(r => ({ ...r.coords, id: r.id, name: r.name[lang] }));
                activeCharts.color = new Chart(colorCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            data: colorData,
                            pointBackgroundColor: colorData.map(d => {
                                const recipe = recipesData.find(r => r.id === d.id);
                                return recipe ? recipe.personalityColor : '#CCCCCC';
                            }),
                            pointBorderColor: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? '#007AFF' : 'rgba(255, 255, 255, 0.8)'),
                            pointBorderWidth: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 4 : 2),
                            pointRadius: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 11 : 7),
                            pointHoverRadius: 11
                        }]
                    },
                    options: chartDefaultOptions('axisSaturation')
                });
            }

            const bwCtx = document.getElementById('bwChart')?.getContext('2d');
            if (bwCtx) {
                const bwData = recipesData.filter(r => r.type === 'bw' && r.coords && typeof r.coords.x === 'number' && typeof r.coords.y === 'number').map(r => ({ ...r.coords, id: r.id, name: r.name[lang] }));
                activeCharts.bw = new Chart(bwCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            data: bwData,
                            pointBackgroundColor: '#475569',
                            pointBorderColor: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? '#007AFF' : 'rgba(255, 255, 255, 0.8)'),
                            pointBorderWidth: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 4 : 2),
                            pointRadius: (ctx) => (ctx.raw?.id === state.selectedRecipeId ? 11 : 7),
                            pointHoverRadius: 11,
                            pointHoverBorderWidth: 3
                        }]
                    },
                    options: chartDefaultOptions('axisChroma')
                });
            }
        }

        /** Toggles the visibility of the mobile navigation menu. */
        function toggleMobileNav(show) {
            const menu = document.getElementById('mobileNavMenu');
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            menu.classList.toggle('translate-x-full', !show);
            hamburgerBtn.setAttribute('aria-expanded', show);
        }

        /** Handles the Picture Profile dropdown navigation menu. */
        function handleDropdownNav() {
            const container = document.getElementById('pp-dropdown-container');
            const btn = document.getElementById('pp-dropdown-btn');
            const menu = document.getElementById('pp-dropdown-menu');
            const chevron = document.getElementById('pp-dropdown-chevron');

            if (!container || !btn || !menu) return;

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = menu.classList.contains('hidden');
                btn.setAttribute('aria-expanded', isHidden);
                if (isHidden) {
                    menu.classList.remove('hidden');
                    setTimeout(() => {
                        menu.classList.remove('opacity-0', 'scale-95');
                        chevron.style.transform = 'rotate(180deg)';
                    }, 10);
                } else {
                    menu.classList.add('opacity-0', 'scale-95');
                    chevron.style.transform = 'rotate(0deg)';
                    menu.addEventListener('transitionend', () => {
                        menu.classList.add('hidden');
                    }, { once: true });
                }
            });

            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    btn.setAttribute('aria-expanded', 'false');
                    menu.classList.add('opacity-0', 'scale-95');
                    chevron.style.transform = 'rotate(0deg)';
                    if (!menu.classList.contains('hidden')) {
                        menu.addEventListener('transitionend', () => {
                            menu.classList.add('hidden');
                        }, { once: true });
                    }
                }
            });
        }


        // =================================================================
        // 6. MAIN INITIALIZATION & EVENT DELEGATION
        // =================================================================

        /**
         * Initializes the application, sets up global event listeners.
         */
        function init() {
            // Use event delegation for better performance and simpler code
            document.body.addEventListener('click', async (e) => {
                const target = e.target;
                
                // --- Lightbox Handling ---
                if (state.lightbox.isOpen) {
                    if (target.id === 'lightbox-bg' || target.closest('#lightbox-close')) { closeLightbox(); } 
                    else if (target.closest('#lightbox-next')) { navigateLightbox(1); } 
                    else if (target.closest('#lightbox-prev')) { navigateLightbox(-1); }
                    const thumb = target.closest('.lightbox-thumb');
                    if (thumb) {
                        state.lightbox.currentIndex = parseInt(thumb.dataset.index);
                        updateLightboxContent();
                    }
                    return; 
                }

                // --- Element-specific Handling ---
                const lightboxTrigger = target.closest('.lightbox-trigger-thumb');
                const homeBtn = target.closest('#homeBtn');
                const navBtn = target.closest('.nav-btn'); 
                const mobileNavBtn = target.closest('.nav-btn-mobile');
                const langBtn = target.closest('.lang-btn');
                const startQuizBtn = target.closest('#startQuizBtn');
                const exploreMoreBtn = target.closest('#exploreMoreBtn');
                const hamburgerBtn = target.closest('#hamburgerBtn');
                const closeMobileNavBtn = target.closest('#closeMobileNavBtn');
                
                if (hamburgerBtn) { toggleMobileNav(true); return; }
                if (closeMobileNavBtn || (target.id === 'mobileNavMenu' && !target.closest('#mobileNavMenu > div'))) { toggleMobileNav(false); return; }
                if (mobileNavBtn) {
                    toggleMobileNav(false);
                    state.selectedRecipeId = null; state.isMobileDetailActive = false;
                    await renderView(mobileNavBtn.dataset.view); return;
                }
                if (homeBtn) { state.selectedRecipeId = null; state.isMobileDetailActive = false; await renderView('home'); return; }
                if (navBtn) { 
                    const dropdownMenu = document.getElementById('pp-dropdown-menu');
                    if (dropdownMenu && !dropdownMenu.classList.contains('hidden')) {
                        dropdownMenu.classList.add('opacity-0', 'scale-95', 'hidden');
                        document.getElementById('pp-dropdown-chevron').style.transform = 'rotate(0deg)';
                    }
                    state.selectedRecipeId = null; 
                    state.isMobileDetailActive = false; 
                    await renderView(navBtn.dataset.view); 
                    return; 
                }
                if (exploreMoreBtn) { state.selectedRecipeId = null; state.isMobileDetailActive = false; await renderView('recipeFormulas'); return; }
                if (langBtn) { state.currentLang = langBtn.id.replace('lang', '').toLowerCase(); await renderView(state.currentView); return; }

                // --- Quiz Handling ---
                const quizOption = target.closest('.quiz-option');
                const quizChoice = target.closest('.quiz-choice-option');
                if (startQuizBtn) { state.quizStep = 0; state.quizAnswers = {}; await renderView('quiz'); return; }
                if (quizOption) {
                    if(!quizOption.classList.contains('selected')) {
                        const group = quizOption.closest('[data-quiz-group]').dataset.quizGroup;
                        state.quizAnswers[group] = quizOption.dataset.value;
                        document.querySelectorAll(`[data-quiz-group="${group}"] .quiz-option`).forEach(opt => opt.classList.remove('selected'));
                        quizOption.classList.add('selected');
                        setTimeout(() => {
                            state.quizStep++;
                            if (state.quizStep >= quizQuestions.length) handleQuizSubmit(); else renderView('quiz');
                        }, 250);
                    }
                    return;
                }
                 if (quizChoice) { 
                    state.selectedRecipeId = quizChoice.dataset.recipeId; 
                    state.isMobileDetailActive = true;
                    await renderView('recipeFormulas'); return; 
                }

                // --- Recipe Library Handling ---
                const recipeItemContent = target.closest('.recipe-item-content');
                const recipeDot = target.closest('.recipe-dot');
                const recipeCompareCb = target.closest('.recipe-compare-cb');
                const compareBtn = target.closest('#compareBtn');
                const compareWithOriginalBtn = target.closest('#compareWithOriginalBtn');
                const aiTuningBtn = target.closest('#aiTuningBtn');
                const backToListBtn = target.closest('#backToListBtn');
                const closeModalBtn = target.closest('#closeComparisonModalBtn');

                if (recipeItemContent || recipeDot) { handleRecipeSelection(target.closest('[data-recipe-id]').dataset.recipeId, 'div'); return; }
                if (recipeCompareCb) { handleRecipeSelection(recipeCompareCb.dataset.recipeId, 'checkbox'); return; }
                if (compareBtn && !compareBtn.disabled) { handleAiComparison(state.comparisonList[0], state.comparisonList[1]); return; }
                if (compareWithOriginalBtn) { handleAiComparison(compareWithOriginalBtn.dataset.originalId, null, state.lastGeneratedAiRecipe); return; }
                if (aiTuningBtn) { handleAiAdjustment(aiTuningBtn); return; }
                if (backToListBtn) { state.isMobileDetailActive = false; renderLibraryDetails(); return; }
                if (closeModalBtn) { document.getElementById('comparisonModal').classList.add('hidden'); return; }
                if (lightboxTrigger) {
                    const recipeId = lightboxTrigger.dataset.recipeId;
                    const recipe = recipesData.find(r => r.id === recipeId);
                    if (recipe && recipe.demoImages && recipe.demoImages.length > 0) {
                         openLightbox(recipe.demoImages, parseInt(lightboxTrigger.dataset.index));
                    }
                    return;
                }

                if (document.getElementById('filtersContainer')?.contains(target)) { handleFilterClick(e); return; }
            });

            // Accessibility: Add keyboard support for elements with role="button"
            document.body.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    const target = e.target;
                    if (target.matches('.quiz-option, .quiz-choice-option, .recipe-item-content, .lightbox-trigger-thumb, .lightbox-thumb')) {
                        e.preventDefault();
                        target.click();
                    }
                }
                // Lightbox keyboard navigation
                if (state.lightbox.isOpen) {
                    if (e.key === 'ArrowRight') { navigateLightbox(1); }
                    else if (e.key === 'ArrowLeft') { navigateLightbox(-1); }
                    else if (e.key === 'Escape') { closeLightbox(); }
                }
            });
            
            document.body.addEventListener('input', (e) => {
                if (e.target.id === 'searchInput') {
                    renderLibraryList();
                }
            });
            
            window.addEventListener('resize', () => { if(state.currentView === 'recipeFormulas') renderLibraryDetails(); });
            
            // Initial render
            renderView('home');
            handleDropdownNav();
        }

        // Wait for the DOM to be fully loaded before running the init function
        document.addEventListener("DOMContentLoaded", init);

    </script>
</body>
</html>
